<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTD Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            --bg: #1a1d23;
            --bg-subtle: #1a1d24;
            --panel: #242831;
            --panel-alt: #2a2f3a;
            --panel-hover: #4a4f5b;
            --border: #3a3f4b;
            --border-strong: #5a6170;
            --text: #e4e6eb;
            --muted: #adb5bd;
            --muted-2: #6c757d;
            --neutral: #6c757d;
            --neutral-hover: #5c636a;
            --accent: #0d6efd;
            --accent-hover: #0b5ed7;
            --accent-glow: rgba(13, 110, 253, 0.6);
            --accent-glow-soft: rgba(13, 110, 253, 0.3);
            --accent-surface: rgba(13, 110, 253, 0.05);
            --accent-surface-strong: rgba(13, 110, 253, 0.08);
            --success: #28a745;
            --success-hover: #218838;
            --warning: #fd7e14;
            --warning-hover: #e36c08;
            --highlight: #ff8c00;
            --danger: #dc3545;
            --danger-hover: #bb2d3b;
            --drag-hover: #3a4555;
            --drag-outline: #2a3545;
            --overlay: rgba(0,0,0,0.8);
            --overlay-soft: rgba(0,0,0,0.5);
            --shadow: rgba(0,0,0,0.5);
            --shadow-soft: rgba(0,0,0,0.3);
            --shadow-strong: rgba(0,0,0,0.4);
        }
        body[data-theme="paper"] {
            --bg: #f5f2ec;
            --bg-subtle: #ede6db;
            --panel: #ffffff;
            --panel-alt: #efe7dc;
            --panel-hover: #e4dbcd;
            --border: #d6cec2;
            --border-strong: #bfb6a7;
            --text: #2a2a2a;
            --muted: #6f6a61;
            --muted-2: #8a8377;
            --neutral: #8a8377;
            --neutral-hover: #787063;
            --accent: #1b6f8a;
            --accent-hover: #165d73;
            --accent-glow: rgba(27, 111, 138, 0.45);
            --accent-glow-soft: rgba(27, 111, 138, 0.25);
            --accent-surface: rgba(27, 111, 138, 0.08);
            --accent-surface-strong: rgba(27, 111, 138, 0.14);
            --success: #3b8d4a;
            --success-hover: #2f703b;
            --warning: #b86a1d;
            --warning-hover: #9a5718;
            --highlight: #a0522d;
            --danger: #b6423a;
            --danger-hover: #92352f;
            --drag-hover: #d9d0c3;
            --drag-outline: #cfc5b7;
            --overlay: rgba(30, 24, 18, 0.55);
            --overlay-soft: rgba(30, 24, 18, 0.35);
            --shadow: rgba(25, 20, 14, 0.2);
            --shadow-soft: rgba(25, 20, 14, 0.15);
            --shadow-strong: rgba(25, 20, 14, 0.25);
        }
        body { 
            font-family: var(--font-ui);
            background: var(--bg); 
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }
        .container { max-width: 1800px; margin: 0 auto; padding: 20px; height: 100%; display: flex; flex-direction: column; }
        
        #loginModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--overlay);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .login-box {
            background: var(--panel);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px var(--shadow);
            width: 400px;
            max-width: 90%;
        }
        
        .login-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 24px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .login-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
        }
        
        .login-btn {
            padding: 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        
        .login-btn:hover {
            background: var(--accent-hover);
        }
        
        .login-error {
            color: var(--danger);
            font-size: 13px;
            text-align: center;
        }
        
        .login-info {
            color: var(--muted);
            font-size: 12px;
            text-align: center;
            margin-top: 12px;
        }
        
        .admin-btn {
            background: var(--neutral);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            margin-right: 8px;
        }
        
        .admin-btn:hover {
            background: var(--neutral-hover);
        }
        
        #adminPanel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--overlay);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        #adminPanel.show {
            display: flex;
        }
        
        .admin-box {
            background: var(--panel);
            padding: 30px;
            border-radius: 12px;
            width: 600px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .admin-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
        }
        
        .admin-section {
            margin-bottom: 30px;
        }
        
        .admin-section h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: var(--muted);
        }
        
        .user-list {
            background: var(--bg);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 16px;
        }
        
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid var(--border);
        }
        
        .user-item:last-child {
            border-bottom: none;
        }
        
        .user-badge {
            background: var(--accent);
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            margin-left: 8px;
        }
        
        .delete-user-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .delete-user-btn:hover {
            background: var(--danger-hover);
        }
        
        .create-user-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .admin-close-btn {
            background: var(--neutral);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-top: 16px;
        }
        
        .admin-close-btn:hover {
            background: var(--neutral-hover);
        }
        
        #appContent {
            display: none;
        }
        
        #appContent.show {
            display: flex;
        }
        
        .grid-row { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            grid-template-rows: 100%;
            gap: 16px; 
            margin-bottom: 16px; 
            flex: 0 0 50%; 
            min-height: 0; 
        }
        
        .bottom-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            flex: 1;
            min-height: 0;
        }
        
        .projects-wrapper {
            grid-column: 1 / 3;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        .projects-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }
        
        .projects-sidebar {
            background: var(--bg-subtle);
            overflow-y: scroll;
            border-right: 1px solid var(--border);
        }
        
        .projects-sidebar::-webkit-scrollbar {
            width: 8px;
        }
        
        .projects-sidebar::-webkit-scrollbar-track {
            background: var(--bg-subtle);
            border-radius: 4px;
        }
        
        .projects-sidebar::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        .projects-sidebar::-webkit-scrollbar-thumb:hover {
            background: var(--panel-hover);
        }
        
        .projects-detail {
            overflow-y: scroll;
            padding: 8px;
        }
        
        .projects-detail::-webkit-scrollbar {
            width: 8px;
        }
        
        .projects-detail::-webkit-scrollbar-track {
            background: var(--bg-subtle);
            border-radius: 4px;
        }
        
        .projects-detail::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        .projects-detail::-webkit-scrollbar-thumb:hover {
            background: var(--panel-hover);
        }
        
        .project-list-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--panel-alt);
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
            user-select: none;
        }
        
        .project-list-item:hover {
            background: var(--panel);
        }
        
        .project-list-item.active {
            background: var(--panel-alt);
            border-left-color: var(--accent);
        }
        
        .project-chevron {
            font-size: 10px;
            color: var(--muted-2);
            width: 12px;
            text-align: center;
        }
        
        .project-list-item-name {
            flex: 1;
            font-size: 14px;
        }
        
        .project-list-insert-indicator {
            position: absolute;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent);
            border-radius: 2px;
            box-shadow: 0 0 8px var(--accent-glow);
            animation: pulse 0.6s ease-in-out infinite;
            pointer-events: none;
            z-index: 100;
        }
        
        .project-list-insert-indicator.before {
            top: 0;
        }
        
        .project-list-insert-indicator.after {
            bottom: 0;
        }
        
        .project-list-item {
            position: relative;
        }
        
        .project-list-item.dragging {
            opacity: 0.4;
        }
        
        .pane {
            background: var(--panel);
            border-radius: 12px;
            box-shadow: 0 1px 3px var(--shadow-soft);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            min-height: 0;
        }
        
        .pane-header {
            padding: 10px 16px;
            border-bottom: 1px solid var(--border);
            background: var(--panel-alt);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 14px;
            min-height: 40px;
        }
        
        .pane-content {
            flex: 1;
            overflow-y: scroll;
            padding: 8px;
            min-height: 0;
        }
        
        .pane-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .pane-content::-webkit-scrollbar-track {
            background: var(--bg-subtle);
            border-radius: 4px;
        }
        
        .pane-content::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        .pane-content::-webkit-scrollbar-thumb:hover {
            background: var(--panel-hover);
        }
        
        .item {
            background: var(--panel-alt);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: move;
            transition: all 0.2s;
            position: relative;
        }
        
        .item:hover {
            border-color: var(--border-strong);
            box-shadow: 0 2px 4px var(--shadow-soft);
        }
        
        .item.dragging {
            opacity: 0.5;
        }
        
        .drop-target-hover {
            background: var(--drag-hover) !important;
            border-color: var(--accent) !important;
            box-shadow: 0 0 0 2px var(--accent-glow-soft) !important;
        }
        
        .drop-target-project {
            background: var(--drag-outline) !important;
            outline: 2px dashed var(--accent) !important;
            outline-offset: -2px;
        }
        
        .insert-indicator {
            position: absolute;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent);
            border-radius: 2px;
            box-shadow: 0 0 8px var(--accent-glow);
            animation: pulse 0.6s ease-in-out infinite;
            pointer-events: none;
            z-index: 100;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scaleY(1); }
            50% { opacity: 0.7; transform: scaleY(1.5); }
        }
        
        .pane-content.drop-zone-active {
            background: var(--accent-surface);
            outline: 2px dashed var(--accent);
            outline-offset: -2px;
            border-radius: 8px;
        }
        
        .project-pane.drop-zone-active {
            background: var(--accent-surface-strong) !important;
            outline: 2px solid var(--accent) !important;
            outline-offset: -2px;
        }
        
        .item-title {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .item.done .item-title {
            text-decoration: line-through;
            color: var(--muted-2);
            opacity: 0.6;
        }
        
        .item-meta {
            display: flex;
            gap: 8px;
            font-size: 11px;
            color: var(--muted-2);
            flex-wrap: wrap;
        }
        
        .item-date {
            color: var(--warning);
        }
        
        .item-project {
            color: var(--accent);
        }
        
        .quick-capture {
            padding: 12px;
            background: var(--panel-alt);
            border-bottom: 1px solid var(--border);
        }
        
        .quick-capture input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            margin-bottom: 6px;
            font-size: 13px;
            background: var(--bg);
            color: var(--text);
        }
        
        .quick-capture-row {
            display: grid;
            grid-template-columns: 2fr 1.5fr auto;
            gap: 6px;
            margin-bottom: 6px;
            align-items: center;
        }
        
        .quick-capture-row label {
            padding-left: 8px;
            white-space: nowrap;
        }
        
        .quick-capture button {
            width: 100%;
            padding: 8px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
        }
        
        .quick-capture button:hover {
            background: var(--success-hover);
        }
        
        .project-pane {
            width: 300px;
            min-width: 300px;
            max-width: 300px;
            flex-shrink: 0;
            background: var(--panel-alt);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: opacity 0.2s;
        }
        
        .project-pane.dragging {
            opacity: 0.4;
        }
        
        .project-pane-insert-indicator {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--accent);
            border-radius: 2px;
            box-shadow: 0 0 8px var(--accent-glow);
            animation: pulse 0.6s ease-in-out infinite;
            pointer-events: none;
            z-index: 100;
        }
        
        .project-pane-insert-indicator.before {
            left: 0;
        }
        
        .project-pane-insert-indicator.after {
            right: 0;
        }
        
        .project-header {
            font-size: 14px;
            font-weight: 600;
            color: var(--muted-2);
            margin-bottom: 12px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .drag-handle {
            cursor: move;
            font-size: 16px;
            color: var(--muted-2);
            opacity: 0.6;
            user-select: none;
            line-height: 1;
        }
        
        .drag-handle:hover {
            opacity: 1;
        }
        
        .project-items {
            flex: 1;
            overflow-y: scroll;
            overflow-x: hidden;
            min-height: 0;
        }
        
        .project-items::-webkit-scrollbar {
            width: 8px;
        }
        
        .project-items::-webkit-scrollbar-track {
            background: var(--bg-subtle);
            border-radius: 4px;
        }
        
        .project-items::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        .project-items::-webkit-scrollbar-thumb:hover {
            background: var(--panel-hover);
        }
        
        .project-header:hover {
            color: var(--accent);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--muted);
            font-size: 12px;
        }
        
        .btn-new-project {
            background: var(--accent);
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            margin-left: auto;
            line-height: 1.2;
        }
        
        .btn-new-project:hover {
            background: var(--accent-hover);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--overlay-soft);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: var(--panel);
            padding: 24px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            background: var(--bg);
            color: var(--text);
        }
        
        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        .btn-primary {
            background: var(--accent);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--accent-hover);
        }
        
        .btn-secondary {
            background: var(--neutral);
            color: white;
        }
        
        .btn-secondary:hover {
            background: var(--neutral-hover);
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background: var(--warning-hover);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: var(--danger-hover);
        }
        
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border-strong);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .checkbox.done {
            background: var(--accent);
            border-color: var(--accent);
        }
        
        .checkbox.done::after {
            content: '‚úì';
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .item-with-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        
        .item-details {
            flex: 1;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-strong);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--muted-2);
        }
        
        /* Context Menu Styles */
        #contextMenu {
            position: fixed;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 20px var(--shadow-strong);
            z-index: 3000;
            min-width: 180px;
            display: none;
        }
        
        #contextMenu.show {
            display: block;
        }
        
        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text);
            border-bottom: 1px solid var(--border);
        }
        
        .context-menu-item:last-child {
            border-bottom: none;
        }
        
        .context-menu-item:hover {
            background: var(--panel-alt);
        }
        
        .context-menu-item:first-child {
            border-radius: 8px 8px 0 0;
        }
        
        .context-menu-item:last-child {
            border-radius: 0 0 8px 8px;
        }
        
        /* Project Selection Modal */
        #projectSelectModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--overlay);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3500;
        }
        
        #projectSelectModal.show {
            display: flex;
        }
        
        .project-select-box {
            background: var(--panel);
            padding: 30px;
            border-radius: 12px;
            width: 400px;
            max-width: 90%;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .project-select-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
        }
        
        .project-select-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .project-select-item {
            padding: 12px;
            background: var(--bg);
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .project-select-item:hover {
            background: var(--panel-alt);
            border-color: var(--accent);
        }
        
        .project-select-buttons {
            display: flex;
            gap: 10px;
        }
        
        .project-select-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* Mobile Styles */
        @media (max-width: 768px) {
            body {
                height: auto;
                overflow: auto;
            }
            
            .container {
                padding: 8px;
                height: auto;
            }
            
            /* Stack grid vertically */
            .grid-row {
                display: flex;
                flex-direction: column;
                gap: 16px;
                margin-bottom: 16px;
                flex: none;
            }
            
            /* Reorder panes on mobile: inbox, calendar, next actions, projects, someday, time, user */
            .grid-row .pane:nth-child(1) { order: 1; } /* Inbox */
            .grid-row .pane:nth-child(2) { order: 2; } /* Calendar */
            .grid-row .pane:nth-child(3) { order: 3; } /* Next Actions */
            .grid-row .pane:nth-child(4) { order: 7; } /* Account */
            
            .bottom-row {
                display: flex;
                flex-direction: column;
                gap: 16px;
                flex: none;
            }
            
            .projects-wrapper {
                order: 4; /* Projects after Next Actions */
            }
            
            .bottom-row .pane:nth-child(2) { order: 5; } /* Someday */
            .bottom-row .pane:nth-child(3) { order: 6; } /* Time */
            
            /* Stack projects vertically */
            .projects-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .projects-sidebar {
                border-right: none;
                border-bottom: 1px solid var(--border);
                max-height: 200px;
            }
            
            .pane {
                width: 100%;
                min-height: auto;
                height: auto;
                max-height: none;
            }
            
            .project-pane {
                width: 100%;
                min-width: auto;
                max-width: none;
            }
            
            .project-pane-insert-indicator.before {
                left: 0;
                right: auto;
                top: 0;
                bottom: auto;
                width: 100%;
                height: 4px;
            }
            
            .project-pane-insert-indicator.after {
                left: 0;
                right: auto;
                top: auto;
                bottom: 0;
                width: 100%;
                height: 4px;
            }
            
            .quick-capture {
                padding: 8px;
            }
            
            .quick-capture input[type="text"] {
                font-size: 14px;
            }
            
            .modal-content {
                width: 95%;
                margin: 10px;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .login-box {
                width: 90%;
                max-width: 350px;
            }
            
            .admin-panel {
                width: 95%;
                max-width: none;
                max-height: 90vh;
                overflow-y: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal">
        <div class="login-box">
            <h1 class="login-title" data-i18n="login.title">GTD Login</h1>
            <form class="login-form" onsubmit="login(event)">
                <input type="text" id="loginUsername" class="login-input" placeholder="Username" data-i18n-placeholder="login.username" required autocomplete="username">
                <input type="password" id="loginPassword" class="login-input" placeholder="Password" data-i18n-placeholder="login.password" autocomplete="current-password">
                <button type="submit" class="login-btn" data-i18n="login.submit">Login</button>
                <div id="loginError" class="login-error"></div>
            </form>
        </div>
    </div>
    
    <!-- Password Setup Modal -->
        <div id="passwordSetupModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--overlay); display: none; align-items: center; justify-content: center; z-index: 2000;">
            <div class="login-box">
                <h1 class="login-title" data-i18n="passwordSetup.title">Set Your Password</h1>
                <form class="login-form" onsubmit="setPassword(event)">
                    <input type="password" id="setupPassword" class="login-input" placeholder="Choose Password" data-i18n-placeholder="passwordSetup.password" required autocomplete="new-password">
                    <input type="password" id="setupPasswordConfirm" class="login-input" placeholder="Confirm Password" data-i18n-placeholder="passwordSetup.confirm" required autocomplete="new-password">
                    <button type="submit" class="login-btn" data-i18n="passwordSetup.submit">Set Password</button>
                <div id="setupError" class="login-error"></div>
            </form>
        </div>
    </div>
    
    <div id="appContent" class="container">
        <!-- Top Row: Inbox, Calendar, Next Actions, Account -->
        <div class="grid-row">
            <div class="pane" data-status="inbox">
                <div class="pane-header" data-i18n="pane.inbox">üì• Inbox</div>
                <div class="quick-capture">
                    <input type="text" id="quickTitle" placeholder="Quick capture..." data-i18n-placeholder="quickCapture.placeholder">
                    <div class="quick-capture-row">
                        <input type="date" id="quickDate">
                        <input type="time" id="quickTime">
                        <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; cursor: pointer;">
                            <input type="checkbox" id="quickDeadline" style="cursor: pointer;">
                            <span data-i18n="quickCapture.deadline">Deadline</span>
                        </label>
                    </div>
                    <button onclick="quickCapture()" data-i18n="quickCapture.add">Add</button>
                </div>
                <div class="pane-content" id="inbox-content"></div>
            </div>
            
            <div class="pane">
                <div class="pane-header" data-i18n="pane.calendar">üìÖ Calendar</div>
                <div class="pane-content" id="calendar-content"></div>
            </div>
            
            <div class="pane">
                <div class="pane-header" data-i18n="pane.nextActions">‚ö° Next Actions</div>
                <div class="pane-content" id="next-content"></div>
            </div>
            
            <div class="pane">
                <div class="pane-header" data-i18n="pane.account">üë§ Account</div>
                <div class="pane-content" style="padding: 16px;">
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;" data-i18n="account.loggedInAs">Logged in as</div>
                        <div style="font-weight: 600; font-size: 14px;" id="currentUser"></div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 12px; color: var(--muted); margin-bottom: 8px;" data-i18n="account.stats">Stats</div>
                        <div style="font-size: 13px; line-height: 1.8;">
                            <div>üìä <span data-i18n="stats.totalItemsLabel">Total Items</span>: <span id="statsItems" style="font-weight: 600;">0</span></div>
                            <div>‚úÖ <span data-i18n="stats.doneLabel">Done</span>: <span id="statsDone" style="font-weight: 600;">0</span></div>
                            <div>üìÅ <span data-i18n="stats.projectsLabel">Projects</span>: <span id="statsProjects" style="font-weight: 600;">0</span></div>
                            <div>‚è∞ <span data-i18n="stats.scheduledLabel">Scheduled</span>: <span id="statsScheduled" style="font-weight: 600;">0</span></div>
                        </div>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button id="adminBtn" class="btn btn-secondary" onclick="showAdminPanel()" style="display:none; width: 100%; padding: 8px;" data-i18n="account.adminPanel">Admin Panel</button>
                        <button class="btn btn-danger" onclick="logout()" style="width: 100%; padding: 8px;" data-i18n="account.logout">Logout</button>
                        <button class="btn btn-secondary" onclick="deleteAllDoneItems()" style="width: 100%; padding: 8px;" data-i18n="account.deleteDone">Delete Done Items</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bottom Row: Projects, Someday, Time -->
        <div class="bottom-row">
            <div class="projects-wrapper">
                <div class="pane" style="height: 100%;">
                    <div class="pane-header">
                        <span data-i18n="pane.projects">üóÇÔ∏è Projects</span>
                        <button class="btn-new-project" onclick="newProject()" data-i18n="projects.new">+ New Project</button>
                    </div>
                    <div class="projects-container">
                        <div class="projects-sidebar" id="projects-list"></div>
                        <div class="projects-detail" id="projects-detail">
                            <div class="empty-state" data-i18n="projects.selectHint">Select a project to view its items</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="pane" data-status="someday">
                <div class="pane-header" data-i18n="pane.someday">üí≠ Someday</div>
                <div class="pane-content" id="someday-content"></div>
            </div>
            
            <div class="pane">
                <div class="pane-header" data-i18n="pane.time">‚è∞ Time</div>
                <div class="pane-content" id="time-content"></div>
            </div>
        </div>
    </div>
    
    <!-- Admin Panel -->
    <div id="adminPanel" onclick="if(event.target === this) closeAdminPanel()">
        <div class="admin-box">
            <h2 class="admin-title" data-i18n="admin.title">Admin Panel</h2>
            
            <div class="admin-section">
                <h3 data-i18n="admin.users">Users</h3>
                <div id="userList" class="user-list"></div>
            </div>
            
            <div class="admin-section">
                <h3 data-i18n="admin.createUser">Create New User</h3>
                <form class="create-user-form" onsubmit="createUser(event)">
                    <input type="text" id="newUsername" class="form-control" placeholder="Username" data-i18n-placeholder="admin.username" required>
                    <button type="submit" class="btn btn-primary" data-i18n="admin.create">Create User</button>
                    <div id="createUserError" class="login-error"></div>
                </form>
                <div class="login-info" style="margin-top: 8px;" data-i18n="admin.passwordHint">New users will be prompted to set their password on first login</div>
            </div>
            
            <button class="admin-close-btn" onclick="closeAdminPanel()" data-i18n="common.close">Close</button>
        </div>
    </div>

    <!-- Item Edit Modal -->
    <div id="itemModal" class="modal" onclick="if(event.target === this) closeItemModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="item.editTitle">Edit Item</h2>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="item.title">Title</label>
                <input type="text" id="editTitle" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="item.notes">Notes</label>
                <textarea id="editNotes" class="form-control"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="item.dueDate">Due Date</label>
                <input type="date" id="editDate" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="item.startTime">Start Time</label>
                <input type="time" id="editTime" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="editDeadline" style="cursor: pointer;">
                    <span data-i18n="item.deadline">Deadline</span>
                </label>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="item.project">Project</label>
                <select id="editProject" class="form-control">
                    <option value="" data-i18n="item.none">None</option>
                </select>
            </div>
            <div class="form-actions">
                <button class="btn btn-danger" onclick="deleteItem()" data-i18n="common.delete">Delete</button>
                <button class="btn btn-secondary" onclick="closeItemModal()" data-i18n="common.cancel">Cancel</button>
                <button class="btn btn-primary" onclick="saveItem()" data-i18n="common.save">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Context Menu -->
        <div id="contextMenu">
            <div class="context-menu-item" data-action="move-inbox" data-i18n="context.moveInbox">üì• Move to Inbox</div>
            <div class="context-menu-item" data-action="move-someday" data-i18n="context.moveSomeday">üí≠ Move to Someday</div>
            <div class="context-menu-item" data-action="move-project" data-i18n="context.moveProject">üìÅ Move to Project</div>
    </div>
    
    <!-- Project Selection Modal -->
    <div id="projectSelectModal" onclick="if(event.target === this) closeProjectSelectModal()">
        <div class="project-select-box">
            <div class="project-select-title" data-i18n="projects.select">Select Project</div>
            <div class="project-select-list" id="projectSelectList"></div>
            <div class="project-select-buttons">
                <button class="btn btn-secondary" onclick="closeProjectSelectModal()" data-i18n="common.cancel">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Project Edit Modal -->
    <div id="projectModal" class="modal" onclick="if(event.target === this) closeProjectModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="projectModalTitle">New Project</h2>
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="projects.name">Name</label>
                <input type="text" id="projectName" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="projects.outcome">Desired Outcome</label>
                <textarea id="projectOutcome" class="form-control"></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-danger" id="deleteProjectBtn" onclick="deleteProject()" style="display:none;" data-i18n="common.delete">Delete</button>
                <button class="btn btn-secondary" onclick="closeProjectModal()" data-i18n="common.cancel">Cancel</button>
                <button class="btn btn-primary" onclick="saveProject()" data-i18n="common.save">Save</button>
            </div>
        </div>
    </div>

    <script>
        let data = { projects: [], items: [], nextProjectId: 1, nextItemId: 1 };
        let currentItem = null;
        let currentProject = null;
        let draggedItem = null;
        let draggedProject = null;
        let projectDropTarget = null;
        let currentUser = null;
        let isAdmin = false;
        let currentLanguage = 'en';

        const STRINGS = {
            en: {
                'app.title': 'GTD Dashboard',
                'login.title': 'GTD Login',
                'login.username': 'Username',
                'login.password': 'Password',
                'login.submit': 'Login',
                'login.failed': 'Login failed. Please try again.',
                'passwordSetup.title': 'Set Your Password',
                'passwordSetup.password': 'Choose Password',
                'passwordSetup.confirm': 'Confirm Password',
                'passwordSetup.submit': 'Set Password',
                'passwordSetup.mismatch': 'Passwords do not match',
                'passwordSetup.short': 'Password must be at least 4 characters',
                'passwordSetup.failed': 'Failed to set password. Please try again.',
                'pane.inbox': 'üì• Inbox',
                'pane.calendar': 'üìÖ Calendar',
                'pane.nextActions': '‚ö° Next Actions',
                'pane.account': 'üë§ Account',
                'pane.projects': 'üóÇÔ∏è Projects',
                'pane.someday': 'üí≠ Someday',
                'pane.time': '‚è∞ Time',
                'quickCapture.placeholder': 'Quick capture...',
                'quickCapture.deadline': 'Deadline',
                'quickCapture.add': 'Add',
                'account.loggedInAs': 'Logged in as',
                'account.stats': 'Stats',
                'account.adminPanel': 'Admin Panel',
                'account.logout': 'Logout',
                'account.deleteDone': 'Delete Done Items',
                'stats.totalItemsLabel': 'Total Items',
                'stats.doneLabel': 'Done',
                'stats.projectsLabel': 'Projects',
                'stats.scheduledLabel': 'Scheduled',
                'projects.new': '+ New Project',
                'projects.selectHint': 'Select a project to view its items',
                'projects.none': 'No projects. Click "+ New Project" to create one.',
                'projects.noneAvailable': 'No projects available. Create a project first.',
                'projects.select': 'Select Project',
                'projects.newTitle': 'New Project',
                'projects.editTitle': 'Edit Project',
                'projects.name': 'Name',
                'projects.outcome': 'Desired Outcome',
                'projects.noItems': 'No items in this project',
                'calendar.empty': 'No scheduled items',
                'next.empty': 'No next actions',
                'admin.title': 'Admin Panel',
                'admin.users': 'Users',
                'admin.createUser': 'Create New User',
                'admin.username': 'Username',
                'admin.create': 'Create User',
                'admin.passwordHint': 'New users will be prompted to set their password on first login',
                'admin.createFailed': 'Failed to create user.',
                'admin.badge': 'ADMIN',
                'admin.resetPassword': 'Reset Password',
                'context.moveInbox': 'üì• Move to Inbox',
                'context.moveSomeday': 'üí≠ Move to Someday',
                'context.moveProject': 'üìÅ Move to Project',
                'item.editTitle': 'Edit Item',
                'item.title': 'Title',
                'item.notes': 'Notes',
                'item.dueDate': 'Due Date',
                'item.startTime': 'Start Time',
                'item.deadline': 'Deadline',
                'item.project': 'Project',
                'item.deadlineFlag': ' (D)',
                'item.none': 'None',
                'common.close': 'Close',
                'common.cancel': 'Cancel',
                'common.save': 'Save',
                'common.delete': 'Delete',
                'alerts.logoutConfirm': 'Logout?',
                'alerts.noDoneItems': 'No done items to delete.',
                'alerts.deleteDoneConfirm': 'Delete {count} done item(s)? This cannot be undone.',
                'alerts.deleteDoneSuccess': 'Deleted {count} done item(s).',
                'alerts.deleteDoneFailed': 'Failed to delete some items. Please try again.',
                'alerts.resetPasswordConfirm': 'Reset password for "{username}"? They will be prompted to set a new password on next login.',
                'alerts.resetPasswordFailed': 'Failed to reset password: {message}',
                'alerts.resetPasswordFailedGeneric': 'Failed to reset password.',
                'alerts.deleteUserConfirm': 'Delete user "{username}"? This will also delete their data.',
                'alerts.deleteUserFailed': 'Failed to delete user.',
                'alerts.deleteItemConfirm': 'Delete this item?',
                'alerts.deleteProjectConfirm': 'Delete this project? Items will be moved to inbox.',
                'date.today': 'Today'
            },
            es: {
                'app.title': 'Panel GTD',
                'login.title': 'Acceso GTD',
                'login.username': 'Usuario',
                'login.password': 'Contrasena',
                'login.submit': 'Entrar',
                'login.failed': 'Error de inicio de sesion. Intentalo de nuevo.',
                'passwordSetup.title': 'Configura tu contrasena',
                'passwordSetup.password': 'Elige contrasena',
                'passwordSetup.confirm': 'Confirmar contrasena',
                'passwordSetup.submit': 'Guardar contrasena',
                'passwordSetup.mismatch': 'Las contrasenas no coinciden',
                'passwordSetup.short': 'La contrasena debe tener al menos 4 caracteres',
                'passwordSetup.failed': 'No se pudo guardar la contrasena. Intentalo de nuevo.',
                'pane.inbox': 'üì• Bandeja de entrada',
                'pane.calendar': 'üìÖ Calendario',
                'pane.nextActions': '‚ö° Proximas acciones',
                'pane.account': 'üë§ Cuenta',
                'pane.projects': 'üóÇÔ∏è Proyectos',
                'pane.someday': 'üí≠ Alg√∫n dia',
                'pane.time': '‚è∞ Tiempo',
                'quickCapture.placeholder': 'Captura rapida...',
                'quickCapture.deadline': 'Plazo',
                'quickCapture.add': 'Agregar',
                'account.loggedInAs': 'Sesion iniciada como',
                'account.stats': 'Estadisticas',
                'account.adminPanel': 'Panel de admin',
                'account.logout': 'Salir',
                'account.deleteDone': 'Eliminar completados',
                'stats.totalItemsLabel': 'Total de items',
                'stats.doneLabel': 'Hechos',
                'stats.projectsLabel': 'Proyectos',
                'stats.scheduledLabel': 'Programados',
                'projects.new': '+ Nuevo proyecto',
                'projects.selectHint': 'Selecciona un proyecto para ver sus items',
                'projects.none': 'No hay proyectos. Pulsa "+ Nuevo proyecto" para crear uno.',
                'projects.noneAvailable': 'No hay proyectos disponibles. Crea uno primero.',
                'projects.select': 'Seleccionar proyecto',
                'projects.newTitle': 'Nuevo proyecto',
                'projects.editTitle': 'Editar proyecto',
                'projects.name': 'Nombre',
                'projects.outcome': 'Resultado deseado',
                'projects.noItems': 'No hay items en este proyecto',
                'calendar.empty': 'No hay elementos programados',
                'next.empty': 'No hay proximas acciones',
                'admin.title': 'Panel de admin',
                'admin.users': 'Usuarios',
                'admin.createUser': 'Crear usuario',
                'admin.username': 'Usuario',
                'admin.create': 'Crear',
                'admin.passwordHint': 'Los usuarios nuevos deberan configurar su contrasena en el primer acceso',
                'admin.createFailed': 'No se pudo crear el usuario.',
                'admin.badge': 'ADMIN',
                'admin.resetPassword': 'Restablecer contrasena',
                'context.moveInbox': 'üì• Mover a bandeja',
                'context.moveSomeday': 'üí≠ Mover a algun dia',
                'context.moveProject': 'üìÅ Mover a proyecto',
                'item.editTitle': 'Editar item',
                'item.title': 'Titulo',
                'item.notes': 'Notas',
                'item.dueDate': 'Fecha limite',
                'item.startTime': 'Hora de inicio',
                'item.deadline': 'Plazo',
                'item.project': 'Proyecto',
                'item.deadlineFlag': ' (P)',
                'item.none': 'Ninguno',
                'common.close': 'Cerrar',
                'common.cancel': 'Cancelar',
                'common.save': 'Guardar',
                'common.delete': 'Eliminar',
                'alerts.logoutConfirm': 'Salir?',
                'alerts.noDoneItems': 'No hay items completados para eliminar.',
                'alerts.deleteDoneConfirm': 'Eliminar {count} item(s) completado(s)? Esto no se puede deshacer.',
                'alerts.deleteDoneSuccess': 'Se eliminaron {count} item(s) completado(s).',
                'alerts.deleteDoneFailed': 'No se pudieron eliminar algunos items. Intentalo de nuevo.',
                'alerts.resetPasswordConfirm': 'Restablecer contrasena de "{username}"? Se le pedira crear una nueva en el proximo acceso.',
                'alerts.resetPasswordFailed': 'No se pudo restablecer la contrasena: {message}',
                'alerts.resetPasswordFailedGeneric': 'No se pudo restablecer la contrasena.',
                'alerts.deleteUserConfirm': 'Eliminar al usuario "{username}"? Esto tambien eliminara sus datos.',
                'alerts.deleteUserFailed': 'No se pudo eliminar el usuario.',
                'alerts.deleteItemConfirm': 'Eliminar este item?',
                'alerts.deleteProjectConfirm': 'Eliminar este proyecto? Los items pasaran a la bandeja.',
                'date.today': 'Hoy'
            }
        };

        function t(key, vars = {}) {
            const dictionary = STRINGS[currentLanguage] || STRINGS.en;
            let text = dictionary[key] || STRINGS.en[key] || key;
            Object.keys(vars).forEach((k) => {
                text = text.replaceAll(`{${k}}`, vars[k]);
            });
            return text;
        }

        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach((el) => {
                const key = el.getAttribute('data-i18n');
                const value = t(key);
                if (value) {
                    el.textContent = value;
                }
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach((el) => {
                const key = el.getAttribute('data-i18n-placeholder');
                const value = t(key);
                if (value) {
                    el.setAttribute('placeholder', value);
                }
            });
            document.title = t('app.title');
            document.documentElement.lang = currentLanguage;
        }

        function setLanguage(lang) {
            currentLanguage = STRINGS[lang] ? lang : 'en';
            localStorage.setItem('lang', currentLanguage);
            applyTranslations();
            if (document.getElementById('appContent').classList.contains('show')) {
                render();
            }
            if (isAdmin && document.getElementById('adminPanel').classList.contains('show')) {
                loadUsers();
            }
        }

        function setTheme(theme) {
            document.body.dataset.theme = theme;
            localStorage.setItem('theme', theme);
        }

        const savedTheme = localStorage.getItem('theme') || 'slate';
        const savedLanguage = localStorage.getItem('lang') || 'en';
        setTheme(savedTheme);
        setLanguage(savedLanguage);
        
        // Check session on load
        async function checkSession() {
            try {
                const response = await fetch('/api/check-session');
                const result = await response.json();
                if (result.authenticated) {
                    currentUser = result.username;
                    isAdmin = result.isAdmin || false;
                    document.getElementById('currentUser').textContent = currentUser;
                    if (isAdmin) {
                        document.getElementById('adminBtn').style.display = 'inline-block';
                    }
                    document.getElementById('loginModal').style.display = 'none';
                    document.getElementById('appContent').classList.add('show');
                    await loadData();
                }
            } catch (error) {
                console.error('Session check failed:', error);
            }
        }
        
        async function login(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.needsPasswordSetup) {
                        // User needs to set password
                        document.getElementById('loginModal').style.display = 'none';
                        document.getElementById('passwordSetupModal').style.display = 'flex';
                        window.setupUsername = username;
                    } else {
                        // Normal login
                        currentUser = result.username;
                        isAdmin = result.isAdmin || false;
                        document.getElementById('currentUser').textContent = currentUser;
                        if (isAdmin) {
                            document.getElementById('adminBtn').style.display = 'inline-block';
                        }
                        document.getElementById('loginModal').style.display = 'none';
                        document.getElementById('appContent').classList.add('show');
                        document.getElementById('loginError').textContent = '';
                        await loadData();
                    }
                } else {
                    document.getElementById('loginError').textContent = result.message;
                }
            } catch (error) {
                document.getElementById('loginError').textContent = t('login.failed');
            }
        }
        
        async function setPassword(e) {
            e.preventDefault();
            const password = document.getElementById('setupPassword').value;
            const confirm = document.getElementById('setupPasswordConfirm').value;
            
            if (password !== confirm) {
                document.getElementById('setupError').textContent = t('passwordSetup.mismatch');
                return;
            }
            
            if (password.length < 4) {
                document.getElementById('setupError').textContent = t('passwordSetup.short');
                return;
            }
            
            try {
                const response = await fetch('/api/set-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: window.setupUsername, password })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentUser = result.username;
                    isAdmin = result.isAdmin || false;
                    document.getElementById('currentUser').textContent = currentUser;
                    if (isAdmin) {
                        document.getElementById('adminBtn').style.display = 'inline-block';
                    }
                    document.getElementById('passwordSetupModal').style.display = 'none';
                    document.getElementById('appContent').classList.add('show');
                    await loadData();
                } else {
                    document.getElementById('setupError').textContent = result.message;
                }
            } catch (error) {
                document.getElementById('setupError').textContent = t('passwordSetup.failed');
            }
        }
        
        async function logout() {
            if (!confirm(t('alerts.logoutConfirm'))) return;
            
            try {
                await fetch('/api/logout', { method: 'POST' });
                location.reload();
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }
        
        async function deleteAllDoneItems() {
            const doneItems = data.items.filter(i => i.done);
            
            if (doneItems.length === 0) {
                alert(t('alerts.noDoneItems'));
                return;
            }
            
            if (!confirm(t('alerts.deleteDoneConfirm', { count: doneItems.length }))) return;
            
            try {
                // Delete each done item
                for (const item of doneItems) {
                    await fetch('/api/items/' + item.id, { method: 'DELETE' });
                }
                
                // Reload data
                await loadData();
                alert(t('alerts.deleteDoneSuccess', { count: doneItems.length }));
            } catch (error) {
                console.error('Failed to delete done items:', error);
                alert(t('alerts.deleteDoneFailed'));
            }
        }
        
        async function showAdminPanel() {
            if (!isAdmin) return;
            
            document.getElementById('adminPanel').classList.add('show');
            await loadUsers();
        }
        
        function closeAdminPanel() {
            document.getElementById('adminPanel').classList.remove('show');
        }
        
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/list-users', { method: 'POST' });
                const result = await response.json();
                
                const userListHtml = result.users.map(user => `
                    <div class="user-item">
                        <div>
                            <strong>${user.username}</strong>
                            ${user.isAdmin ? `<span class="user-badge">${t('admin.badge')}</span>` : ''}
                        </div>
                        <div style="display: flex; gap: 8px;">
                            ${user.username !== 'admin' ? 
                                `<button class="delete-user-btn btn-warning" onclick="resetPassword('${user.username}')">${t('admin.resetPassword')}</button>
                                <button class="delete-user-btn" onclick="deleteUser('${user.username}')">${t('common.delete')}</button>` : 
                                ''}
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('userList').innerHTML = userListHtml;
            } catch (error) {
                console.error('Failed to load users:', error);
            }
        }
        
        async function createUser(e) {
            e.preventDefault();
            
            const username = document.getElementById('newUsername').value.trim();
            
            try {
                const response = await fetch('/api/admin/create-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('newUsername').value = '';
                    document.getElementById('createUserError').textContent = '';
                    await loadUsers();
                    alert(result.message);
                } else {
                    document.getElementById('createUserError').textContent = result.message;
                }
            } catch (error) {
                document.getElementById('createUserError').textContent = t('admin.createFailed');
            }
        }
        
        async function resetPassword(username) {
            if (!confirm(t('alerts.resetPasswordConfirm', { username }))) return;
            
            try {
                const response = await fetch('/api/admin/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                } else {
                    alert(t('alerts.resetPasswordFailed', { message: result.message }));
                }
            } catch (error) {
                alert(t('alerts.resetPasswordFailedGeneric'));
            }
        }
        
        async function deleteUser(username) {
            if (!confirm(t('alerts.deleteUserConfirm', { username }))) return;
            
            try {
                const response = await fetch('/api/admin/delete-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadUsers();
                    alert(result.message);
                } else {
                    alert(result.message);
                }
            } catch (error) {
                alert(t('alerts.deleteUserFailed'));
            }
        }
        
        async function loadData() {
            const response = await fetch('/api/data');
            data = await response.json();
            render();
        }
        
        function getInboxItems() {
            return data.items.filter(i => i.status === 'inbox');
        }
        
        function getSomedayItems() {
            return data.items.filter(i => i.status === 'someday');
        }
        
        function getCalendarItems() {
            return data.items
                .filter(i => i.dueDatetime)
                .sort((a, b) => {
                    const dateA = new Date(a.dueDatetime).getTime();
                    const dateB = new Date(b.dueDatetime).getTime();
                    if (dateA !== dateB) return dateA - dateB;
                    return (a.startTime || '').localeCompare(b.startTime || '');
                });
        }
        
        function getTodayDateString() {
            // Get today's date in local timezone as YYYY-MM-DD
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function getNextActions() {
            const candidates = [];
            const todayStr = getTodayDateString();
            
            // Step 1: Get first non-done item from each project
            data.projects.forEach(project => {
                const projectItems = data.items
                    .filter(i => i.projectId === project.id && i.status === 'projects')
                    .sort((a, b) => (a.position || 0) - (b.position || 0));
                const firstUndone = projectItems.find(i => !i.done);
                if (firstUndone) {
                    candidates.push({ ...firstUndone, project });
                }
            });
            
            // Step 2: Add any other not-done items from any zone with today's date or future deadlines
            const candidateIds = new Set(candidates.map(c => c.id));
            data.items.forEach(item => {
                if (item.dueDatetime && !item.done && !candidateIds.has(item.id)) {
                    const itemDate = item.dueDatetime.includes('T') ? item.dueDatetime.split('T')[0] : item.dueDatetime;
                    // Include if it's today's date OR if it's a deadline (can be done in advance)
                    if (itemDate === todayStr || item.deadline) {
                        const project = item.projectId ? data.projects.find(p => p.id === item.projectId) : null;
                        candidates.push({ ...item, project });
                    }
                }
            });
            
            
            // Step 3: Filter candidates to only include items with no date OR today's date OR future deadlines
            const nextActions = candidates.filter(item => {
                if (!item.dueDatetime) return true; // No date = include
                const itemDate = item.dueDatetime.includes('T') ? item.dueDatetime.split('T')[0] : item.dueDatetime;
                const isToday = itemDate === todayStr;
                const isDeadline = item.deadline;
                const matches = isToday || isDeadline;
                return matches; // Include if date is today OR it's a deadline
            });
            
            return nextActions;
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString(currentLanguage, { month: 'short', day: 'numeric' });
        }
        
        function renderItem(item, showCheckbox = true, draggable = true) {
            const isDone = item.done;
            
            let html = '<div class="item' + (isDone ? ' done' : '') + '" draggable="' + draggable + '" data-id="' + item.id + '">';
            
            if (showCheckbox) {
                html += '<div class="item-with-checkbox">';
                html += '<div class="checkbox ' + (isDone ? 'done' : '') + '" onclick="toggleDone(' + item.id + ', event)"></div>';
                html += '<div class="item-details">';
            }
            
            // Show date before title if present
            let titleHtml = '';
            if (item.dueDatetime) {
                const todayStr = getTodayDateString();
                const itemDate = item.dueDatetime.includes('T') ? item.dueDatetime.split('T')[0] : item.dueDatetime;
                const isToday = itemDate === todayStr;
                
                
                titleHtml += '<span style="color: var(--muted-2); font-size: 11px; margin-right: 6px;">';
                if (isToday) {
                    titleHtml += '<span style="color: var(--highlight);">' + t('date.today') + '</span>';
                } else {
                    titleHtml += formatDate(item.dueDatetime);
                }
                if (item.startTime) titleHtml += ' ' + item.startTime;
                if (item.deadline) titleHtml += t('item.deadlineFlag');
                titleHtml += '</span>';
            }
            titleHtml += item.title;
            
            html += '<div class="item-title">' + titleHtml + '</div>';
            
            if (showCheckbox) {
                html += '</div></div>';
            }
            
            html += '</div>';
            return html;
        }
        
        function render() {
            // Inbox
            document.getElementById('inbox-content').innerHTML = 
                getInboxItems().map(i => renderItem(i)).join('');
            
            // Calendar
            const calItems = getCalendarItems();
            document.getElementById('calendar-content').innerHTML = 
                calItems.length ? calItems.map(i => renderItem(i, true, false)).join('') : '<div class="empty-state">' + t('calendar.empty') + '</div>';
            
            // Next Actions
            const nextActions = getNextActions();
            document.getElementById('next-content').innerHTML = 
                nextActions.length ? nextActions.map(i => renderItem(i, true, false)).join('') : '<div class="empty-state">' + t('next.empty') + '</div>';
            
            // Someday
            document.getElementById('someday-content').innerHTML = 
                getSomedayItems().map(i => renderItem(i)).join('');
            
            // Projects
            let projectsListHtml = '';
            const sortedProjects = data.projects.sort((a, b) => (a.position || 0) - (b.position || 0));
            
            if (sortedProjects.length === 0) {
                projectsListHtml = '<div class="empty-state">' + t('projects.none') + '</div>';
            } else {
                sortedProjects.forEach(project => {
                    const itemCount = data.items.filter(i => i.projectId === project.id && i.status === 'projects' && !i.done).length;
                    const isActive = selectedProjectId === project.id;
                    const chevron = isActive ? '‚ñº' : '‚ñ∂';
                    projectsListHtml += '<div class="project-list-item' + (isActive ? ' active' : '') + '" data-project-id="' + project.id + '" draggable="true">';
                    projectsListHtml += '<span class="project-chevron" draggable="false">' + chevron + '</span>';
                    projectsListHtml += '<span class="project-list-item-name" draggable="false">' + project.name + '</span>';
                    projectsListHtml += '<span style="font-size: 11px; color: var(--muted-2);" draggable="false">' + itemCount + '</span>';
                    projectsListHtml += '</div>';
                });
            }
            
            document.getElementById('projects-list').innerHTML = projectsListHtml;
            
            // Attach project interaction listeners
            document.querySelectorAll('.project-list-item').forEach(el => {
                const projectId = parseInt(el.dataset.projectId);
                
                // Left click to select (only if not dragging)
                el.addEventListener('click', function(e) {
                    selectProject(projectId);
                });
                
                // Right click to edit
                el.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    editProject(projectId);
                });
                
                // Drag handlers
                el.addEventListener('dragstart', handleProjectDragStart);
                el.addEventListener('dragend', handleProjectDragEnd);
                el.addEventListener('dragover', handleProjectDragOver);
                el.addEventListener('dragenter', handleProjectDragEnter);
                el.addEventListener('dragleave', handleProjectDragLeave);
                el.addEventListener('drop', handleProjectDrop);
            });

            const projectsList = document.getElementById('projects-list');
            projectsList.addEventListener('dragover', handleProjectListDragOver);
            projectsList.addEventListener('drop', handleProjectDrop);
            
            // Update project selector in edit modal
            const projectSelect = document.getElementById('editProject');
            projectSelect.innerHTML = '<option value="">' + t('item.none') + '</option>' + 
                data.projects.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('');
            
            // Attach drag listeners
            document.querySelectorAll('.item').forEach(el => {
                el.addEventListener('dragstart', handleDragStart);
                el.addEventListener('dragend', handleDragEnd);
                el.addEventListener('dragover', handleDragOver);
                el.addEventListener('dragenter', handleDragEnter);
                el.addEventListener('dragleave', handleDragLeave);
                el.addEventListener('drop', handleDrop);
                el.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('checkbox')) {
                        e.preventDefault();
                        showContextMenu(e, parseInt(el.dataset.id));
                    }
                });
                el.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    openItemModal(parseInt(el.dataset.id));
                });
            });
            
            // Attach drop listeners
            document.querySelectorAll('[data-status]').forEach(el => {
                el.addEventListener('dragover', handleDragOver);
                el.addEventListener('dragenter', handleDragEnter);
                el.addEventListener('dragleave', handleDragLeave);
                el.addEventListener('drop', handleDrop);
            });
            
            document.querySelectorAll('[data-project-id]').forEach(el => {
                el.addEventListener('dragover', handleDragOver);
                el.addEventListener('dragenter', handleDragEnter);
                el.addEventListener('dragleave', handleDragLeave);
                el.addEventListener('drop', handleDrop);
            });
            
            // Update stats
            updateStats();
        }
        
        let selectedProjectId = null;
        
        function selectProject(projectId) {
            selectedProjectId = projectId;
            
            // Update active state in sidebar
            document.querySelectorAll('.project-list-item').forEach(el => {
                el.classList.toggle('active', parseInt(el.dataset.projectId) === projectId);
            });
            
            // Render project items in detail panel
            const project = data.projects.find(p => p.id === projectId);
            const projectItems = data.items
                .filter(i => i.projectId === projectId && i.status === 'projects')
                .sort((a, b) => (a.position || 0) - (b.position || 0));
            
            let detailHtml = '';
            if (projectItems.length === 0) {
                detailHtml = '<div class="empty-state">' + t('projects.noItems') + '</div>';
            } else {
                detailHtml = projectItems.map(i => renderItem(i)).join('');
            }
            
            document.getElementById('projects-detail').innerHTML = detailHtml;
            document.getElementById('projects-detail').dataset.projectId = projectId;
            
            // Attach drag listeners to items
            document.querySelectorAll('#projects-detail .item').forEach(el => {
                el.addEventListener('dragstart', handleDragStart);
                el.addEventListener('dragend', handleDragEnd);
                el.addEventListener('dragover', handleDragOver);
                el.addEventListener('dragenter', handleDragEnter);
                el.addEventListener('dragleave', handleDragLeave);
                el.addEventListener('drop', handleDrop);
                el.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('checkbox')) {
                        e.preventDefault();
                        showContextMenu(e, parseInt(el.dataset.id));
                    }
                });
                el.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    openItemModal(parseInt(el.dataset.id));
                });
            });
            
            // Make detail panel droppable
            const detailPanel = document.getElementById('projects-detail');
            detailPanel.addEventListener('dragover', handleDragOver);
            detailPanel.addEventListener('dragenter', handleDragEnter);
            detailPanel.addEventListener('dragleave', handleDragLeave);
            detailPanel.addEventListener('drop', handleDrop);
        }
        
        function updateStats() {
            const totalItems = data.items.length;
            const doneItems = data.items.filter(i => i.done).length;
            const totalProjects = data.projects.length;
            const scheduledItems = data.items.filter(i => i.dueDatetime).length;
            
            document.getElementById('statsItems').textContent = totalItems;
            document.getElementById('statsDone').textContent = doneItems;
            document.getElementById('statsProjects').textContent = totalProjects;
            document.getElementById('statsScheduled').textContent = scheduledItems;
        }
        
        // Project drag and drop handlers
        function handleProjectDragStart(e) {
            const projectItem = e.target.closest('.project-list-item');
            if (!projectItem) return;
            
            draggedProject = parseInt(projectItem.dataset.projectId);
            projectItem.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        
        function handleProjectDragEnd(e) {
            const projectItem = e.target.closest('.project-list-item');
            if (projectItem) {
                projectItem.classList.remove('dragging');
            }
            document.querySelectorAll('.project-pane-insert-indicator, .project-list-insert-indicator').forEach(el => el.remove());
            draggedProject = null;
            projectDropTarget = null;
        }
        
        function handleProjectDragEnter(e) {
            if (!draggedProject) return;
            e.preventDefault();
        }
        
        function handleProjectDragLeave(e) {
            if (!draggedProject) return;
        }
        
        function handleProjectDragOver(e) {
            e.preventDefault();
            if (!draggedProject) return;
            
            const targetItem = e.currentTarget;
            const targetProjectId = parseInt(targetItem.dataset.projectId);
            
            if (targetProjectId === draggedProject) return;
            
            // Remove all existing indicators
            document.querySelectorAll('.project-pane-insert-indicator, .project-list-insert-indicator').forEach(el => el.remove());
            
            // Determine if we're on the top or bottom half of the target item
            const rect = targetItem.getBoundingClientRect();
            const mouseY = e.clientY;
            const midpoint = rect.top + rect.height / 2;
            const insertBefore = mouseY < midpoint;
            
            // Store drop information
            projectDropTarget = { closestProjectId: targetProjectId, insertBefore };
            
            // Show indicator on the current target item
            const indicator = document.createElement('div');
            indicator.className = 'project-list-insert-indicator ' + (insertBefore ? 'before' : 'after');
            targetItem.appendChild(indicator);
        }

        function handleProjectListDragOver(e) {
            if (!draggedProject) return;
            if (e.target.closest('.project-list-item')) return;
            e.preventDefault();

            const list = e.currentTarget;
            const items = list.querySelectorAll('.project-list-item');
            if (!items.length) return;

            const lastItem = items[items.length - 1];
            const lastProjectId = parseInt(lastItem.dataset.projectId);
            if (lastProjectId === draggedProject) return;

            document.querySelectorAll('.project-pane-insert-indicator, .project-list-insert-indicator').forEach(el => el.remove());
            projectDropTarget = { closestProjectId: lastProjectId, insertBefore: false };

            const indicator = document.createElement('div');
            indicator.className = 'project-list-insert-indicator after';
            lastItem.appendChild(indicator);
        }
        
        async function handleProjectDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            document.querySelectorAll('.project-pane-insert-indicator, .project-list-insert-indicator').forEach(el => el.remove());
            
            if (!draggedProject) return;
            if (!projectDropTarget) return;
            
            const projects = data.projects.sort((a, b) => (a.position || 0) - (b.position || 0));
            const oldIndex = projects.findIndex(p => p.id === draggedProject);
            let targetIndex = projects.findIndex(p => p.id === projectDropTarget.closestProjectId);
            
            if (oldIndex === -1 || targetIndex === -1) return;
            
            if (!projectDropTarget.insertBefore) {
                targetIndex++;
            }
            
            if (oldIndex < targetIndex) {
                targetIndex--;
            }
            
            if (oldIndex === targetIndex) return;
            
            // Reorder projects
            const reordered = projects.filter(p => p.id !== draggedProject);
            const draggedProjectObj = projects[oldIndex];
            reordered.splice(targetIndex, 0, draggedProjectObj);
            
            // Update local data immediately (optimistic update)
            reordered.forEach((project, index) => {
                const dataProject = data.projects.find(p => p.id === project.id);
                if (dataProject) {
                    dataProject.position = index;
                }
            });
            
            // Refresh the project list immediately
            render();

            projectDropTarget = null;
            
            // Send update to server in background
            const updates = reordered.map((project, index) => ({
                id: project.id,
                position: index
            }));
            
            fetch('/api/projects/batch', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updates)
            }).catch(err => {
                console.error('Failed to save project positions:', err);
                // On error, reload from server
                loadData();
            });
        }
        
        // Item drag and drop handlers
        function handleDragStart(e) {
            draggedItem = parseInt(e.target.dataset.id);
            e.target.classList.add('dragging');
        }
        
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            // Clean up all visual feedback
            document.querySelectorAll('.drop-target-hover, .drop-target-project, .drop-zone-active').forEach(el => {
                el.classList.remove('drop-target-hover', 'drop-target-project', 'drop-zone-active');
                el._dragDepth = 0; // Reset drag depth counters
            });
            document.querySelectorAll('.insert-indicator').forEach(el => el.remove());
            draggedItem = null;
        }
        
        function handleDragEnter(e) {
            if (!draggedItem) return;
            e.preventDefault();
            
            const target = e.currentTarget;
            
            // Track drag depth to prevent flickering from child elements
            if (!target._dragDepth) target._dragDepth = 0;
            target._dragDepth++;
            
            // Only apply visual feedback on first enter
            if (target._dragDepth !== 1) return;
            
            // Highlight panes
            if (target.dataset.status || target.dataset.projectId) {
                if (target.classList.contains('pane-content')) {
                    target.classList.add('drop-zone-active');
                } else if (target.classList.contains('project-pane')) {
                    target.classList.add('drop-zone-active');
                }
            }
        }
        
        function handleDragLeave(e) {
            if (!draggedItem) return;
            const target = e.currentTarget;
            
            // Track drag depth to prevent flickering from child elements
            if (!target._dragDepth) target._dragDepth = 0;
            target._dragDepth--;
            
            // Only remove visual feedback when fully leaving the element
            if (target._dragDepth > 0) return;
            
            // Remove highlights
            target.classList.remove('drop-target-hover', 'drop-target-project', 'drop-zone-active');
            
            // Remove insertion indicators from this element
            const indicators = target.querySelectorAll('.insert-indicator');
            indicators.forEach(ind => ind.remove());
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            
            if (!draggedItem) return;
            const item = data.items.find(i => i.id === draggedItem);
            if (!item) return;
            
            // Remove all existing indicators
            document.querySelectorAll('.insert-indicator').forEach(el => el.remove());
            
            // Check if we're in the project detail pane and dragging a project item
            const projectDetail = e.target.closest('#projects-detail');
            if (!projectDetail || item.status !== 'projects') return;
            
            const projectId = parseInt(projectDetail.dataset.projectId);
            if (!projectId || item.projectId !== projectId) return;
            
            // Get all items in this project
            const projectItems = Array.from(projectDetail.querySelectorAll('.item'))
                .map(el => {
                    const rect = el.getBoundingClientRect();
                    return {
                        id: parseInt(el.dataset.id),
                        element: el,
                        midpoint: rect.top + rect.height / 2,
                        top: rect.top,
                        bottom: rect.bottom
                    };
                })
                .filter(itemData => itemData.id !== draggedItem); // Exclude dragged item
            
            if (projectItems.length === 0) return;
            
            const mouseY = e.clientY;
            
            // Find closest item based on distance to midpoint
            let closest = projectItems[0];
            let minDistance = Math.abs(mouseY - closest.midpoint);
            
            for (let i = 1; i < projectItems.length; i++) {
                const distance = Math.abs(mouseY - projectItems[i].midpoint);
                if (distance < minDistance) {
                    minDistance = distance;
                    closest = projectItems[i];
                }
            }
            
            // Determine if mouse is above or below the closest item's midpoint
            const insertBefore = mouseY < closest.midpoint;
            
            // Store drop information on the project detail pane
            projectDetail._closestItemId = closest.id;
            projectDetail._insertBefore = insertBefore;
            
            // Show indicator
            const indicator = document.createElement('div');
            indicator.className = 'insert-indicator';
            indicator.style.top = insertBefore ? '-4px' : 'calc(100% + 4px)';
            closest.element.appendChild(indicator);
        }
        
        async function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();  // Prevent bubbling to project pane
            
            // Clean up visual feedback
            document.querySelectorAll('.drop-target-hover, .drop-target-project, .drop-zone-active').forEach(el => {
                el.classList.remove('drop-target-hover', 'drop-target-project', 'drop-zone-active');
            });
            document.querySelectorAll('.insert-indicator').forEach(el => el.remove());
            
            if (!draggedItem) return;
            
            const item = data.items.find(i => i.id === draggedItem);
            if (!item) return;
            
            const target = e.currentTarget;
            
            // Check if dropped in the project detail pane for reordering
            const projectDetail = target.closest('#projects-detail');
            if (projectDetail && projectDetail._closestItemId && item.status === 'projects') {
                const projectId = parseInt(projectDetail.dataset.projectId);
                
                if (item.projectId === projectId) {
                    // Reordering within same project
                    const projectItems = data.items
                        .filter(i => i.projectId === projectId && i.status === 'projects')
                        .sort((a, b) => (a.position || 0) - (b.position || 0));
                    
                    const oldIndex = projectItems.findIndex(i => i.id === draggedItem);
                    let targetIndex = projectItems.findIndex(i => i.id === projectDetail._closestItemId);
                    
                    if (oldIndex !== -1 && targetIndex !== -1) {
                        // If inserting after, increment target index
                        if (!projectDetail._insertBefore) {
                            targetIndex++;
                        }
                        
                        // Adjust if moving down (removal shifts indices)
                        if (oldIndex < targetIndex) {
                            targetIndex--;
                        }
                        
                        // Only update if position actually changes
                        if (oldIndex !== targetIndex) {
                            const reordered = projectItems.filter(i => i.id !== draggedItem);
                            const draggedItemObj = projectItems[oldIndex];
                            reordered.splice(targetIndex, 0, draggedItemObj);
                            
                            // Update local data immediately (optimistic update)
                            reordered.forEach((item, index) => {
                                const dataItem = data.items.find(i => i.id === item.id);
                                if (dataItem) {
                                    dataItem.position = index;
                                }
                            });
                            
                            // Refresh the project view immediately
                            selectProject(selectedProjectId);
                            
                            // Send update to server in background
                            const updates = reordered.map((item, index) => ({
                                id: item.id,
                                position: index
                            }));
                            
                            fetch('/api/items/batch', {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(updates)
                            }).catch(err => {
                                console.error('Failed to save item positions:', err);
                                // On error, reload from server
                                loadData();
                            });
                        }
                        return;
                    }
                }
            }
            
            // Check if dropped on an item to add to that item's project
            if (target.classList.contains('item')) {
                const targetItemId = parseInt(target.dataset.id);
                const targetItem = data.items.find(i => i.id === targetItemId);
                
                if (targetItem && targetItem.projectId) {
                    const projectId = targetItem.projectId;
                    const projectItems = data.items.filter(i => i.projectId === projectId && i.status === 'projects');
                    const maxPos = projectItems.length > 0 ? Math.max(...projectItems.map(i => i.position || 0)) : -1;
                    
                    await fetch('/api/items/' + draggedItem, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'projects', projectId, position: maxPos + 1 })
                    });
                    await loadData();
                    return;
                }
            }
            
            const newStatus = target.dataset.status;
            const newProjectId = target.dataset.projectId;
            
            if (newStatus) {
                // Dropped into inbox or someday
                await fetch('/api/items/' + draggedItem, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus, projectId: null, position: 0 })
                });
            } else if (newProjectId) {
                // Dropped into a project (via project detail pane)
                const projectId = parseInt(newProjectId);
                const projectItems = data.items.filter(i => i.projectId === projectId && i.status === 'projects');
                const maxPos = projectItems.length > 0 ? Math.max(...projectItems.map(i => i.position || 0)) : -1;
                
                await fetch('/api/items/' + draggedItem, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'projects', projectId, position: maxPos + 1 })
                });
            }
            
            await loadData();
        }
        
        async function quickCapture() {
            const title = document.getElementById('quickTitle').value.trim();
            if (!title) return;
            
            const date = document.getElementById('quickDate').value;
            const time = document.getElementById('quickTime').value;
            const deadline = document.getElementById('quickDeadline').checked;
            
            await fetch('/api/items', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title,
                    status: 'inbox',
                    dueDatetime: date || null,
                    startTime: time || null,
                    deadline: deadline,
                    position: 0
                })
            });
            
            document.getElementById('quickTitle').value = '';
            document.getElementById('quickDate').value = '';
            document.getElementById('quickTime').value = '';
            document.getElementById('quickDeadline').checked = false;
            
            await loadData();
        }
        
        async function toggleDone(itemId, e) {
            e.stopPropagation();
            const item = data.items.find(i => i.id === itemId);
            if (!item) return;
            
            await fetch('/api/items/' + itemId, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ done: !item.done })
            });
            
            await loadData();
        }
        
        function openItemModal(itemId) {
            currentItem = data.items.find(i => i.id === itemId);
            if (!currentItem) return;
            
            document.getElementById('editTitle').value = currentItem.title;
            document.getElementById('editNotes').value = currentItem.notes || '';
            document.getElementById('editDate').value = currentItem.dueDatetime ? currentItem.dueDatetime.split('T')[0] : '';
            document.getElementById('editTime').value = currentItem.startTime || '';
            document.getElementById('editDeadline').checked = currentItem.deadline || false;
            document.getElementById('editProject').value = currentItem.projectId || '';
            
            document.getElementById('itemModal').classList.add('show');
        }
        
        function closeItemModal() {
            document.getElementById('itemModal').classList.remove('show');
            currentItem = null;
        }
        
        async function saveItem() {
            if (!currentItem) return;
            
            const title = document.getElementById('editTitle').value.trim();
            if (!title) return;
            
            const updates = {
                title,
                notes: document.getElementById('editNotes').value || null,
                dueDatetime: document.getElementById('editDate').value || null,
                startTime: document.getElementById('editTime').value || null,
                deadline: document.getElementById('editDeadline').checked,
                projectId: parseInt(document.getElementById('editProject').value) || null
            };
            
            if (updates.projectId) {
                updates.status = 'projects';
            } else if (currentItem.status === 'projects') {
                updates.status = 'inbox';
            }
            
            await fetch('/api/items/' + currentItem.id, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updates)
            });
            
            closeItemModal();
            await loadData();
        }
        
        async function deleteItem() {
            if (!currentItem || !confirm(t('alerts.deleteItemConfirm'))) return;
            
            await fetch('/api/items/' + currentItem.id, {
                method: 'DELETE'
            });
            
            closeItemModal();
            await loadData();
        }
        
        // Context Menu Functions
        let contextMenuItem = null;
        
        function showContextMenu(event, itemId) {
            event.preventDefault();
            event.stopPropagation();
            
            contextMenuItem = data.items.find(i => i.id === itemId);
            if (!contextMenuItem) return;
            
            const contextMenu = document.getElementById('contextMenu');
            const menuItems = contextMenu.querySelectorAll('.context-menu-item');
            
            // Show/hide menu items based on current item status
            menuItems.forEach(item => {
                const action = item.getAttribute('data-action');
                
                // Hide current area from the menu
                if (action === 'move-inbox' && contextMenuItem.status === 'inbox') {
                    item.style.display = 'none';
                } else if (action === 'move-someday' && contextMenuItem.status === 'someday') {
                    item.style.display = 'none';
                } else if (action === 'move-project' && contextMenuItem.status === 'projects') {
                    item.style.display = 'none';
                } else {
                    item.style.display = 'block';
                }
            });
            
            // Position the menu at click location
            contextMenu.style.left = event.pageX + 'px';
            contextMenu.style.top = event.pageY + 'px';
            contextMenu.classList.add('show');
        }
        
        function hideContextMenu() {
            document.getElementById('contextMenu').classList.remove('show');
            contextMenuItem = null;
        }
        
        async function handleContextMenuAction(action) {
            if (!contextMenuItem) return;
            
            
            const itemId = contextMenuItem.id; // Save the ID before hiding the menu
            
            if (action === 'move-inbox') {
                await moveItemTo(itemId, 'inbox');
                hideContextMenu();
            } else if (action === 'move-someday') {
                await moveItemTo(itemId, 'someday');
                hideContextMenu();
            } else if (action === 'move-project') {
                hideContextMenu();
                showProjectSelectModal(itemId);
            }
        }
        
        async function moveItemTo(itemId, targetStatus, projectId = null) {
            const updates = {
                status: targetStatus,
                projectId: projectId
            };
            
            await fetch('/api/items/' + itemId, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updates)
            });
            
            await loadData();
        }
        
        function showProjectSelectModal(itemId) {
            const item = data.items.find(i => i.id === itemId);
            if (!item) {
                return;
            }
            const projectList = document.getElementById('projectSelectList');
            projectList.innerHTML = data.projects.map(project => 
                '<div class="project-select-item" onclick="selectProjectAndMove(' + itemId + ', ' + project.id + ')">' +
                project.name +
                '</div>'
            ).join('');
            
            if (data.projects.length === 0) {
                projectList.innerHTML = '<div style="color: var(--muted); text-align: center; padding: 20px;">' + t('projects.noneAvailable') + '</div>';
            }
            
            document.getElementById('projectSelectModal').classList.add('show');
        }
        
        function closeProjectSelectModal() {
            document.getElementById('projectSelectModal').classList.remove('show');
        }
        
        async function selectProjectAndMove(itemId, projectId) {
            await moveItemTo(itemId, 'projects', projectId);
            closeProjectSelectModal();
        }
        
        function newProject() {
            currentProject = null;
            document.getElementById('projectModalTitle').textContent = t('projects.newTitle');
            document.getElementById('projectName').value = '';
            document.getElementById('projectOutcome').value = '';
            document.getElementById('deleteProjectBtn').style.display = 'none';
            document.getElementById('projectModal').classList.add('show');
        }
        
        function editProject(projectId) {
            currentProject = data.projects.find(p => p.id === projectId);
            if (!currentProject) return;
            
            document.getElementById('projectModalTitle').textContent = t('projects.editTitle');
            document.getElementById('projectName').value = currentProject.name;
            document.getElementById('projectOutcome').value = currentProject.outcome || '';
            document.getElementById('deleteProjectBtn').style.display = 'inline-block';
            document.getElementById('projectModal').classList.add('show');
        }
        
        function closeProjectModal() {
            document.getElementById('projectModal').classList.remove('show');
            currentProject = null;
        }
        
        async function saveProject() {
            const name = document.getElementById('projectName').value.trim();
            if (!name) return;
            
            const projectData = {
                name,
                outcome: document.getElementById('projectOutcome').value || null,
                status: 'active'
            };
            
            if (currentProject) {
                await fetch('/api/projects/' + currentProject.id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(projectData)
                });
            } else {
                await fetch('/api/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(projectData)
                });
            }
            
            closeProjectModal();
            await loadData();
        }
        
        async function deleteProject() {
            if (!currentProject || !confirm(t('alerts.deleteProjectConfirm'))) return;
            
            await fetch('/api/projects/' + currentProject.id, {
                method: 'DELETE'
            });
            
            closeProjectModal();
            await loadData();
        }
        
        // Keyboard shortcut for quick capture
        document.addEventListener('keydown', function(e) {
            if ((e.key === 'q' || e.key === 'c') && !e.ctrlKey && !e.metaKey && 
                document.activeElement.tagName !== 'INPUT' && 
                document.activeElement.tagName !== 'TEXTAREA') {
                document.getElementById('quickTitle').focus();
            }
        });
        
        // Enter key in quick capture
        document.getElementById('quickTitle').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') quickCapture();
        });
        
        // Context menu event listeners
        document.querySelectorAll('.context-menu-item').forEach(item => {
            item.addEventListener('click', function() {
                const action = this.getAttribute('data-action');
                handleContextMenuAction(action);
            });
        });
        
        // Hide context menu when clicking elsewhere
        document.addEventListener('click', function(e) {
            const contextMenu = document.getElementById('contextMenu');
            if (!contextMenu.contains(e.target) && contextMenu.classList.contains('show')) {
                hideContextMenu();
            }
        });
        
        // Initialize
        checkSession();
    </script>
</body>
</html>
