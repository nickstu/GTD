<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTD Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; 
            background: #1a1d23; 
            color: #e4e6eb;
            height: 100vh;
            overflow: hidden;
        }
        .container { max-width: 1800px; margin: 0 auto; padding: 20px; height: 100%; display: flex; flex-direction: column; }
        
        #loginModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .login-box {
            background: #242831;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            width: 400px;
            max-width: 90%;
        }
        
        .login-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 24px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .login-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #3a3f4b;
            border-radius: 6px;
            background: #1a1d23;
            color: #e4e6eb;
            font-size: 14px;
        }
        
        .login-btn {
            padding: 12px;
            background: #0d6efd;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        
        .login-btn:hover {
            background: #0b5ed7;
        }
        
        .login-error {
            color: #dc3545;
            font-size: 13px;
            text-align: center;
        }
        
        .login-info {
            color: #adb5bd;
            font-size: 12px;
            text-align: center;
            margin-top: 12px;
        }
        
        .admin-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            margin-right: 8px;
        }
        
        .admin-btn:hover {
            background: #5c636a;
        }
        
        #adminPanel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        #adminPanel.show {
            display: flex;
        }
        
        .admin-box {
            background: #242831;
            padding: 30px;
            border-radius: 12px;
            width: 600px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .admin-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
        }
        
        .admin-section {
            margin-bottom: 30px;
        }
        
        .admin-section h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #adb5bd;
        }
        
        .user-list {
            background: #1a1d23;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 16px;
        }
        
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #3a3f4b;
        }
        
        .user-item:last-child {
            border-bottom: none;
        }
        
        .user-badge {
            background: #0d6efd;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            margin-left: 8px;
        }
        
        .delete-user-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .delete-user-btn:hover {
            background: #bb2d3b;
        }
        
        .create-user-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .admin-close-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-top: 16px;
        }
        
        .admin-close-btn:hover {
            background: #5c636a;
        }
        
        #appContent {
            display: none;
        }
        
        #appContent.show {
            display: flex;
        }
        
        .grid-row { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            grid-template-rows: 100%;
            gap: 16px; 
            margin-bottom: 16px; 
            flex: 0 0 50%; 
            min-height: 0; 
        }
        
        .bottom-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            flex: 1;
            min-height: 0;
        }
        
        .projects-wrapper {
            grid-column: 1 / 3;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        .projects-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }
        
        .projects-sidebar {
            background: #1a1d24;
            overflow-y: scroll;
            border-right: 1px solid #3a3f4b;
        }
        
        .projects-sidebar::-webkit-scrollbar {
            width: 8px;
        }
        
        .projects-sidebar::-webkit-scrollbar-track {
            background: #1a1d24;
            border-radius: 4px;
        }
        
        .projects-sidebar::-webkit-scrollbar-thumb {
            background: #3a3f4b;
            border-radius: 4px;
        }
        
        .projects-sidebar::-webkit-scrollbar-thumb:hover {
            background: #4a4f5b;
        }
        
        .projects-detail {
            overflow-y: scroll;
            padding: 8px;
        }
        
        .projects-detail::-webkit-scrollbar {
            width: 8px;
        }
        
        .projects-detail::-webkit-scrollbar-track {
            background: #1a1d24;
            border-radius: 4px;
        }
        
        .projects-detail::-webkit-scrollbar-thumb {
            background: #3a3f4b;
            border-radius: 4px;
        }
        
        .projects-detail::-webkit-scrollbar-thumb:hover {
            background: #4a4f5b;
        }
        
        .project-list-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #2a2f3a;
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
            user-select: none;
        }
        
        .project-list-item:hover {
            background: #242831;
        }
        
        .project-list-item.active {
            background: #2a2f3a;
            border-left-color: #0d6efd;
        }
        
        .project-chevron {
            font-size: 10px;
            color: #6c757d;
            width: 12px;
            text-align: center;
        }
        
        .project-list-item-name {
            flex: 1;
            font-size: 14px;
        }
        
        .project-list-insert-indicator {
            position: absolute;
            left: 0;
            right: 0;
            height: 3px;
            background: #0d6efd;
            border-radius: 2px;
            box-shadow: 0 0 8px rgba(13, 110, 253, 0.6);
            animation: pulse 0.6s ease-in-out infinite;
            pointer-events: none;
            z-index: 100;
        }
        
        .project-list-insert-indicator.before {
            top: 0;
        }
        
        .project-list-insert-indicator.after {
            bottom: 0;
        }
        
        .project-list-item {
            position: relative;
        }
        
        .project-list-item.dragging {
            opacity: 0.4;
        }
        
        .pane {
            background: #242831;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            min-height: 0;
        }
        
        .pane-header {
            padding: 12px 16px;
            border-bottom: 1px solid #3a3f4b;
            background: #2a2f3a;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .pane-content {
            flex: 1;
            overflow-y: scroll;
            padding: 8px;
            min-height: 0;
        }
        
        .pane-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .pane-content::-webkit-scrollbar-track {
            background: #1a1d24;
            border-radius: 4px;
        }
        
        .pane-content::-webkit-scrollbar-thumb {
            background: #3a3f4b;
            border-radius: 4px;
        }
        
        .pane-content::-webkit-scrollbar-thumb:hover {
            background: #4a4f5b;
        }
        
        .item {
            background: #2a2f3a;
            border: 1px solid #3a3f4b;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: move;
            transition: all 0.2s;
            position: relative;
        }
        
        .item:hover {
            border-color: #5a6170;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .item.dragging {
            opacity: 0.5;
        }
        
        .drop-target-hover {
            background: #3a4555 !important;
            border-color: #0d6efd !important;
            box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.3) !important;
        }
        
        .drop-target-project {
            background: #2a3545 !important;
            outline: 2px dashed #0d6efd !important;
            outline-offset: -2px;
        }
        
        .insert-indicator {
            position: absolute;
            left: 0;
            right: 0;
            height: 3px;
            background: #0d6efd;
            border-radius: 2px;
            box-shadow: 0 0 8px rgba(13, 110, 253, 0.6);
            animation: pulse 0.6s ease-in-out infinite;
            pointer-events: none;
            z-index: 100;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scaleY(1); }
            50% { opacity: 0.7; transform: scaleY(1.5); }
        }
        
        .pane-content.drop-zone-active {
            background: rgba(13, 110, 253, 0.05);
            outline: 2px dashed #0d6efd;
            outline-offset: -2px;
            border-radius: 8px;
        }
        
        .project-pane.drop-zone-active {
            background: rgba(13, 110, 253, 0.08) !important;
            outline: 2px solid #0d6efd !important;
            outline-offset: -2px;
        }
        
        .item-title {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .item.done .item-title {
            text-decoration: line-through;
            color: #6c757d;
            opacity: 0.6;
        }
        
        .item-meta {
            display: flex;
            gap: 8px;
            font-size: 11px;
            color: #6c757d;
            flex-wrap: wrap;
        }
        
        .item-date {
            color: #fd7e14;
        }
        
        .item-project {
            color: #0d6efd;
        }
        
        .quick-capture {
            padding: 12px;
            background: #2a2f3a;
            border-bottom: 1px solid #3a3f4b;
        }
        
        .quick-capture input {
            width: 100%;
            padding: 8px;
            border: 1px solid #3a3f4b;
            border-radius: 4px;
            margin-bottom: 6px;
            font-size: 13px;
            background: #1a1d23;
            color: #e4e6eb;
        }
        
        .quick-capture-row {
            display: grid;
            grid-template-columns: 2fr 1.5fr auto;
            gap: 6px;
            margin-bottom: 6px;
            align-items: center;
        }
        
        .quick-capture-row label {
            padding-left: 8px;
            white-space: nowrap;
        }
        
        .quick-capture button {
            width: 100%;
            padding: 8px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
        }
        
        .quick-capture button:hover {
            background: #218838;
        }
        
        .project-pane {
            width: 300px;
            min-width: 300px;
            max-width: 300px;
            flex-shrink: 0;
            background: #2a2f3a;
            border: 1px solid #3a3f4b;
            border-radius: 8px;
            padding: 12px;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: opacity 0.2s;
        }
        
        .project-pane.dragging {
            opacity: 0.4;
        }
        
        .project-pane-insert-indicator {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #0d6efd;
            border-radius: 2px;
            box-shadow: 0 0 8px rgba(13, 110, 253, 0.6);
            animation: pulse 0.6s ease-in-out infinite;
            pointer-events: none;
            z-index: 100;
        }
        
        .project-pane-insert-indicator.before {
            left: 0;
        }
        
        .project-pane-insert-indicator.after {
            right: 0;
        }
        
        .project-header {
            font-size: 14px;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 12px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .drag-handle {
            cursor: move;
            font-size: 16px;
            color: #6c757d;
            opacity: 0.6;
            user-select: none;
            line-height: 1;
        }
        
        .drag-handle:hover {
            opacity: 1;
        }
        
        .project-items {
            flex: 1;
            overflow-y: scroll;
            overflow-x: hidden;
            min-height: 0;
        }
        
        .project-items::-webkit-scrollbar {
            width: 8px;
        }
        
        .project-items::-webkit-scrollbar-track {
            background: #1a1d24;
            border-radius: 4px;
        }
        
        .project-items::-webkit-scrollbar-thumb {
            background: #3a3f4b;
            border-radius: 4px;
        }
        
        .project-items::-webkit-scrollbar-thumb:hover {
            background: #4a4f5b;
        }
        
        .project-header:hover {
            color: #0d6efd;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #adb5bd;
            font-size: 12px;
        }
        
        .btn-new-project {
            background: #0d6efd;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            margin-left: auto;
        }
        
        .btn-new-project:hover {
            background: #0b5ed7;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: #242831;
            padding: 24px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #3a3f4b;
            border-radius: 6px;
            font-size: 14px;
            background: #1a1d23;
            color: #e4e6eb;
        }
        
        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        .btn-primary {
            background: #0d6efd;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0b5ed7;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5c636a;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #bb2d3b;
        }
        
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid #5a6170;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .checkbox.done {
            background: #0d6efd;
            border-color: #0d6efd;
        }
        
        .checkbox.done::after {
            content: '‚úì';
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .item-with-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        
        .item-details {
            flex: 1;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1a1d23;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #5a6170;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #6c757d;
        }
        
        /* Context Menu Styles */
        #contextMenu {
            position: fixed;
            background: #242831;
            border: 1px solid #3a3f4b;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            z-index: 3000;
            min-width: 180px;
            display: none;
        }
        
        #contextMenu.show {
            display: block;
        }
        
        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #e4e6eb;
            border-bottom: 1px solid #3a3f4b;
        }
        
        .context-menu-item:last-child {
            border-bottom: none;
        }
        
        .context-menu-item:hover {
            background: #2a2f3a;
        }
        
        .context-menu-item:first-child {
            border-radius: 8px 8px 0 0;
        }
        
        .context-menu-item:last-child {
            border-radius: 0 0 8px 8px;
        }
        
        /* Project Selection Modal */
        #projectSelectModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3500;
        }
        
        #projectSelectModal.show {
            display: flex;
        }
        
        .project-select-box {
            background: #242831;
            padding: 30px;
            border-radius: 12px;
            width: 400px;
            max-width: 90%;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .project-select-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
        }
        
        .project-select-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .project-select-item {
            padding: 12px;
            background: #1a1d23;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .project-select-item:hover {
            background: #2a2f3a;
            border-color: #0d6efd;
        }
        
        .project-select-buttons {
            display: flex;
            gap: 10px;
        }
        
        .project-select-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* Mobile Styles */
        @media (max-width: 768px) {
            body {
                height: auto;
                overflow: auto;
            }
            
            .container {
                padding: 8px;
                height: auto;
            }
            
            /* Stack grid vertically */
            .grid-row {
                display: flex;
                flex-direction: column;
                gap: 16px;
                margin-bottom: 16px;
                flex: none;
            }
            
            /* Reorder panes on mobile: inbox, calendar, next actions, projects, someday, time, user */
            .grid-row .pane:nth-child(1) { order: 1; } /* Inbox */
            .grid-row .pane:nth-child(2) { order: 2; } /* Calendar */
            .grid-row .pane:nth-child(3) { order: 3; } /* Next Actions */
            .grid-row .pane:nth-child(4) { order: 7; } /* Account */
            
            .bottom-row {
                display: flex;
                flex-direction: column;
                gap: 16px;
                flex: none;
            }
            
            .projects-wrapper {
                order: 4; /* Projects after Next Actions */
            }
            
            .bottom-row .pane:nth-child(2) { order: 5; } /* Someday */
            .bottom-row .pane:nth-child(3) { order: 6; } /* Time */
            
            /* Stack projects vertically */
            .projects-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .projects-sidebar {
                border-right: none;
                border-bottom: 1px solid #3a3f4b;
                max-height: 200px;
            }
            
            .pane {
                width: 100%;
                min-height: auto;
                height: auto;
                max-height: none;
            }
            
            .project-pane {
                width: 100%;
                min-width: auto;
                max-width: none;
            }
            
            .project-pane-insert-indicator.before {
                left: 0;
                right: auto;
                top: 0;
                bottom: auto;
                width: 100%;
                height: 4px;
            }
            
            .project-pane-insert-indicator.after {
                left: 0;
                right: auto;
                top: auto;
                bottom: 0;
                width: 100%;
                height: 4px;
            }
            
            .quick-capture {
                padding: 8px;
            }
            
            .quick-capture input[type="text"] {
                font-size: 14px;
            }
            
            .modal-content {
                width: 95%;
                margin: 10px;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .login-box {
                width: 90%;
                max-width: 350px;
            }
            
            .admin-panel {
                width: 95%;
                max-width: none;
                max-height: 90vh;
                overflow-y: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal">
        <div class="login-box">
            <h1 class="login-title">GTD Login</h1>
            <form class="login-form" onsubmit="login(event)">
                <input type="text" id="loginUsername" class="login-input" placeholder="Username" required autocomplete="username">
                <input type="password" id="loginPassword" class="login-input" placeholder="Password" autocomplete="current-password">
                <button type="submit" class="login-btn">Login</button>
                <div id="loginError" class="login-error"></div>
            </form>
        </div>
    </div>
    
    <!-- Password Setup Modal -->
    <div id="passwordSetupModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 2000;">
        <div class="login-box">
            <h1 class="login-title">Set Your Password</h1>
            <form class="login-form" onsubmit="setPassword(event)">
                <input type="password" id="setupPassword" class="login-input" placeholder="Choose Password" required autocomplete="new-password">
                <input type="password" id="setupPasswordConfirm" class="login-input" placeholder="Confirm Password" required autocomplete="new-password">
                <button type="submit" class="login-btn">Set Password</button>
                <div id="setupError" class="login-error"></div>
            </form>
        </div>
    </div>
    
    <div id="appContent" class="container">
        <!-- Top Row: Inbox, Calendar, Next Actions, Account -->
        <div class="grid-row">
            <div class="pane" data-status="inbox">
                <div class="pane-header">üì• Inbox</div>
                <div class="quick-capture">
                    <input type="text" id="quickTitle" placeholder="Quick capture...">
                    <div class="quick-capture-row">
                        <input type="date" id="quickDate">
                        <input type="time" id="quickTime">
                        <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; cursor: pointer;">
                            <input type="checkbox" id="quickDeadline" style="cursor: pointer;">
                            <span>Deadline</span>
                        </label>
                    </div>
                    <button onclick="quickCapture()">Add</button>
                </div>
                <div class="pane-content" id="inbox-content"></div>
            </div>
            
            <div class="pane">
                <div class="pane-header">üìÖ Calendar</div>
                <div class="pane-content" id="calendar-content"></div>
            </div>
            
            <div class="pane">
                <div class="pane-header">‚ö° Next Actions</div>
                <div class="pane-content" id="next-content"></div>
            </div>
            
            <div class="pane">
                <div class="pane-header">üë§ Account</div>
                <div class="pane-content" style="padding: 16px;">
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 12px; color: #adb5bd; margin-bottom: 4px;">Logged in as</div>
                        <div style="font-weight: 600; font-size: 14px;" id="currentUser"></div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 12px; color: #adb5bd; margin-bottom: 8px;">Stats</div>
                        <div style="font-size: 13px; line-height: 1.8;">
                            <div>üìä Total Items: <span id="statsItems" style="font-weight: 600;">0</span></div>
                            <div>‚úÖ Done: <span id="statsDone" style="font-weight: 600;">0</span></div>
                            <div>üìÅ Projects: <span id="statsProjects" style="font-weight: 600;">0</span></div>
                            <div>‚è∞ Scheduled: <span id="statsScheduled" style="font-weight: 600;">0</span></div>
                        </div>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button id="adminBtn" class="btn btn-secondary" onclick="showAdminPanel()" style="display:none; width: 100%; padding: 8px;">Admin Panel</button>
                        <button class="btn btn-danger" onclick="logout()" style="width: 100%; padding: 8px;">Logout</button>
                        <button class="btn btn-secondary" onclick="deleteAllDoneItems()" style="width: 100%; padding: 8px; background: #6c757d;">Delete Done Items</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bottom Row: Projects, Someday, Time -->
        <div class="bottom-row">
            <div class="projects-wrapper">
                <div class="pane" style="height: 100%;">
                    <div class="pane-header">
                        üóÇÔ∏è Projects
                        <button class="btn-new-project" onclick="newProject()">+ New Project</button>
                    </div>
                    <div class="projects-container">
                        <div class="projects-sidebar" id="projects-list"></div>
                        <div class="projects-detail" id="projects-detail">
                            <div class="empty-state">Select a project to view its items</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="pane" data-status="someday">
                <div class="pane-header">üí≠ Someday</div>
                <div class="pane-content" id="someday-content"></div>
            </div>
            
            <div class="pane">
                <div class="pane-header">‚è∞ Time</div>
                <div class="pane-content" id="time-content"></div>
            </div>
        </div>
    </div>
    
    <!-- Admin Panel -->
    <div id="adminPanel" onclick="if(event.target === this) closeAdminPanel()">
        <div class="admin-box">
            <h2 class="admin-title">Admin Panel</h2>
            
            <div class="admin-section">
                <h3>Users</h3>
                <div id="userList" class="user-list"></div>
            </div>
            
            <div class="admin-section">
                <h3>Create New User</h3>
                <form class="create-user-form" onsubmit="createUser(event)">
                    <input type="text" id="newUsername" class="form-control" placeholder="Username" required>
                    <button type="submit" class="btn btn-primary">Create User</button>
                    <div id="createUserError" class="login-error"></div>
                </form>
                <div class="login-info" style="margin-top: 8px;">New users will be prompted to set their password on first login</div>
            </div>
            
            <button class="admin-close-btn" onclick="closeAdminPanel()">Close</button>
        </div>
    </div>

    <!-- Item Edit Modal -->
    <div id="itemModal" class="modal" onclick="if(event.target === this) closeItemModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Item</h2>
            </div>
            <div class="form-group">
                <label class="form-label">Title</label>
                <input type="text" id="editTitle" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea id="editNotes" class="form-control"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Due Date</label>
                <input type="date" id="editDate" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">Start Time</label>
                <input type="time" id="editTime" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="editDeadline" style="cursor: pointer;">
                    <span>Deadline</span>
                </label>
            </div>
            <div class="form-group">
                <label class="form-label">Project</label>
                <select id="editProject" class="form-control">
                    <option value="">None</option>
                </select>
            </div>
            <div class="form-actions">
                <button class="btn btn-danger" onclick="deleteItem()">Delete</button>
                <button class="btn btn-secondary" onclick="closeItemModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveItem()">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Context Menu -->
    <div id="contextMenu">
        <div class="context-menu-item" data-action="move-inbox">üì• Move to Inbox</div>
        <div class="context-menu-item" data-action="move-someday">üí≠ Move to Someday</div>
        <div class="context-menu-item" data-action="move-project">üìÅ Move to Project</div>
    </div>
    
    <!-- Project Selection Modal -->
    <div id="projectSelectModal" onclick="if(event.target === this) closeProjectSelectModal()">
        <div class="project-select-box">
            <div class="project-select-title">Select Project</div>
            <div class="project-select-list" id="projectSelectList"></div>
            <div class="project-select-buttons">
                <button class="btn btn-secondary" onclick="closeProjectSelectModal()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Project Edit Modal -->
    <div id="projectModal" class="modal" onclick="if(event.target === this) closeProjectModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="projectModalTitle">New Project</h2>
            </div>
            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" id="projectName" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">Desired Outcome</label>
                <textarea id="projectOutcome" class="form-control"></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-danger" id="deleteProjectBtn" onclick="deleteProject()" style="display:none;">Delete</button>
                <button class="btn btn-secondary" onclick="closeProjectModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveProject()">Save</button>
            </div>
        </div>
    </div>

    <script>
        let data = { projects: [], items: [], nextProjectId: 1, nextItemId: 1 };
        let currentItem = null;
        let currentProject = null;
        let draggedItem = null;
        let draggedProject = null;
        let currentUser = null;
        let isAdmin = false;
        
        // Check session on load
        async function checkSession() {
            try {
                const response = await fetch('/api/check-session');
                const result = await response.json();
                if (result.authenticated) {
                    currentUser = result.username;
                    isAdmin = result.isAdmin || false;
                    document.getElementById('currentUser').textContent = currentUser;
                    if (isAdmin) {
                        document.getElementById('adminBtn').style.display = 'inline-block';
                    }
                    document.getElementById('loginModal').style.display = 'none';
                    document.getElementById('appContent').classList.add('show');
                    await loadData();
                }
            } catch (error) {
                console.error('Session check failed:', error);
            }
        }
        
        async function login(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.needsPasswordSetup) {
                        // User needs to set password
                        document.getElementById('loginModal').style.display = 'none';
                        document.getElementById('passwordSetupModal').style.display = 'flex';
                        window.setupUsername = username;
                    } else {
                        // Normal login
                        currentUser = result.username;
                        isAdmin = result.isAdmin || false;
                        document.getElementById('currentUser').textContent = currentUser;
                        if (isAdmin) {
                            document.getElementById('adminBtn').style.display = 'inline-block';
                        }
                        document.getElementById('loginModal').style.display = 'none';
                        document.getElementById('appContent').classList.add('show');
                        document.getElementById('loginError').textContent = '';
                        await loadData();
                    }
                } else {
                    document.getElementById('loginError').textContent = result.message;
                }
            } catch (error) {
                document.getElementById('loginError').textContent = 'Login failed. Please try again.';
            }
        }
        
        async function setPassword(e) {
            e.preventDefault();
            const password = document.getElementById('setupPassword').value;
            const confirm = document.getElementById('setupPasswordConfirm').value;
            
            if (password !== confirm) {
                document.getElementById('setupError').textContent = 'Passwords do not match';
                return;
            }
            
            if (password.length < 4) {
                document.getElementById('setupError').textContent = 'Password must be at least 4 characters';
                return;
            }
            
            try {
                const response = await fetch('/api/set-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: window.setupUsername, password })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentUser = result.username;
                    isAdmin = result.isAdmin || false;
                    document.getElementById('currentUser').textContent = currentUser;
                    if (isAdmin) {
                        document.getElementById('adminBtn').style.display = 'inline-block';
                    }
                    document.getElementById('passwordSetupModal').style.display = 'none';
                    document.getElementById('appContent').classList.add('show');
                    await loadData();
                } else {
                    document.getElementById('setupError').textContent = result.message;
                }
            } catch (error) {
                document.getElementById('setupError').textContent = 'Failed to set password. Please try again.';
            }
        }
        
        async function logout() {
            if (!confirm('Logout?')) return;
            
            try {
                await fetch('/api/logout', { method: 'POST' });
                location.reload();
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }
        
        async function deleteAllDoneItems() {
            const doneItems = data.items.filter(i => i.done);
            
            if (doneItems.length === 0) {
                alert('No done items to delete.');
                return;
            }
            
            if (!confirm(`Delete ${doneItems.length} done item(s)? This cannot be undone.`)) return;
            
            try {
                // Delete each done item
                for (const item of doneItems) {
                    await fetch('/api/items/' + item.id, { method: 'DELETE' });
                }
                
                // Reload data
                await loadData();
                alert(`Deleted ${doneItems.length} done item(s).`);
            } catch (error) {
                console.error('Failed to delete done items:', error);
                alert('Failed to delete some items. Please try again.');
            }
        }
        
        async function showAdminPanel() {
            if (!isAdmin) return;
            
            document.getElementById('adminPanel').classList.add('show');
            await loadUsers();
        }
        
        function closeAdminPanel() {
            document.getElementById('adminPanel').classList.remove('show');
        }
        
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/list-users', { method: 'POST' });
                const result = await response.json();
                
                const userListHtml = result.users.map(user => `
                    <div class="user-item">
                        <div>
                            <strong>${user.username}</strong>
                            ${user.isAdmin ? '<span class="user-badge">ADMIN</span>' : ''}
                        </div>
                        <div style="display: flex; gap: 8px;">
                            ${user.username !== 'admin' ? 
                                `<button class="delete-user-btn" onclick="resetPassword('${user.username}')" style="background: #ffc107; color: #000;">Reset Password</button>
                                <button class="delete-user-btn" onclick="deleteUser('${user.username}')">Delete</button>` : 
                                ''}
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('userList').innerHTML = userListHtml;
            } catch (error) {
                console.error('Failed to load users:', error);
            }
        }
        
        async function createUser(e) {
            e.preventDefault();
            
            const username = document.getElementById('newUsername').value.trim();
            
            try {
                const response = await fetch('/api/admin/create-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('newUsername').value = '';
                    document.getElementById('createUserError').textContent = '';
                    await loadUsers();
                    alert(result.message);
                } else {
                    document.getElementById('createUserError').textContent = result.message;
                }
            } catch (error) {
                document.getElementById('createUserError').textContent = 'Failed to create user';
            }
        }
        
        async function resetPassword(username) {
            if (!confirm(`Reset password for "${username}"? They will be prompted to set a new password on next login.`)) return;
            
            try {
                const response = await fetch('/api/admin/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                } else {
                    alert('Failed to reset password: ' + result.message);
                }
            } catch (error) {
                alert('Failed to reset password');
            }
        }
        
        async function deleteUser(username) {
            if (!confirm(`Delete user "${username}"? This will also delete their data.`)) return;
            
            try {
                const response = await fetch('/api/admin/delete-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadUsers();
                    alert(result.message);
                } else {
                    alert(result.message);
                }
            } catch (error) {
                alert('Failed to delete user');
            }
        }
        
        async function loadData() {
            const response = await fetch('/api/data');
            data = await response.json();
            await cleanupInvalidItems();
            render();
        }
        
        async function cleanupInvalidItems() {
            const validStatuses = ['inbox', 'someday', 'projects'];
            const validProjectIds = new Set(data.projects.map(p => p.id));
            let modified = false;
            
            data.items.forEach(item => {
                // Check if status is invalid
                if (!validStatuses.includes(item.status)) {
                    console.log(`Invalid status "${item.status}" for item ${item.id}, sending to inbox`);
                    item.status = 'inbox';
                    item.projectId = null;
                    modified = true;
                }
                // Check if item has projectId but status is not 'projects'
                else if (item.projectId && item.status !== 'projects') {
                    console.log(`Item ${item.id} has projectId but status is "${item.status}", sending to inbox`);
                    item.status = 'inbox';
                    item.projectId = null;
                    modified = true;
                }
                // Check if status is 'projects' but has invalid/missing projectId
                else if (item.status === 'projects' && (!item.projectId || !validProjectIds.has(item.projectId))) {
                    console.log(`Item ${item.id} has invalid projectId ${item.projectId}, sending to inbox`);
                    item.status = 'inbox';
                    item.projectId = null;
                    modified = true;
                }
            });
            
            // Save cleaned data back to server if modifications were made
            if (modified) {
                console.log('Invalid items found, saving cleaned data...');
                await fetch('/api/data', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            }
        }
        
        function getInboxItems() {
            return data.items.filter(i => i.status === 'inbox');
        }
        
        function getSomedayItems() {
            return data.items.filter(i => i.status === 'someday');
        }
        
        function getCalendarItems() {
            return data.items
                .filter(i => i.dueDatetime)
                .sort((a, b) => {
                    const dateA = new Date(a.dueDatetime).getTime();
                    const dateB = new Date(b.dueDatetime).getTime();
                    if (dateA !== dateB) return dateA - dateB;
                    return (a.startTime || '').localeCompare(b.startTime || '');
                });
        }
        
        function getTodayDateString() {
            // Get today's date in local timezone as YYYY-MM-DD
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function getNextActions() {
            const candidates = [];
            const todayStr = getTodayDateString();
            console.log('Today string for comparison:', todayStr, 'Full date object:', new Date());
            
            // Step 1: Get first non-done item from each project
            data.projects.forEach(project => {
                const projectItems = data.items
                    .filter(i => i.projectId === project.id && i.status === 'projects')
                    .sort((a, b) => (a.position || 0) - (b.position || 0));
                const firstUndone = projectItems.find(i => !i.done);
                if (firstUndone) {
                    candidates.push({ ...firstUndone, project });
                }
            });
            
            // Step 2: Add any other not-done items from any zone with today's date or future deadlines
            const candidateIds = new Set(candidates.map(c => c.id));
            data.items.forEach(item => {
                if (item.dueDatetime && !item.done && !candidateIds.has(item.id)) {
                    const itemDate = item.dueDatetime.includes('T') ? item.dueDatetime.split('T')[0] : item.dueDatetime;
                    console.log('Item', item.title, 'date:', itemDate, 'equals today?', itemDate === todayStr, 'is deadline?', item.deadline);
                    // Include if it's today's date OR if it's a deadline (can be done in advance)
                    if (itemDate === todayStr || item.deadline) {
                        const project = item.projectId ? data.projects.find(p => p.id === item.projectId) : null;
                        candidates.push({ ...item, project });
                    }
                }
            });
            
            console.log('Candidates before filtering:', candidates.length);
            
            // Step 3: Filter candidates to only include items with no date OR today's date OR future deadlines
            const nextActions = candidates.filter(item => {
                if (!item.dueDatetime) return true; // No date = include
                const itemDate = item.dueDatetime.includes('T') ? item.dueDatetime.split('T')[0] : item.dueDatetime;
                const isToday = itemDate === todayStr;
                const isDeadline = item.deadline;
                const matches = isToday || isDeadline;
                console.log('Filtering', item.title, 'itemDate:', itemDate, 'is today?', isToday, 'is deadline?', isDeadline, 'included?', matches);
                return matches; // Include if date is today OR it's a deadline
            });
            
            console.log('Next actions after filtering:', nextActions.length);
            return nextActions;
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        
        function renderItem(item, showCheckbox = true) {
            const isDone = item.done;
            
            let html = '<div class="item' + (isDone ? ' done' : '') + '" draggable="true" data-id="' + item.id + '">';
            
            if (showCheckbox) {
                html += '<div class="item-with-checkbox">';
                html += '<div class="checkbox ' + (isDone ? 'done' : '') + '" onclick="toggleDone(' + item.id + ', event)"></div>';
                html += '<div class="item-details">';
            }
            
            // Show date before title if present
            let titleHtml = '';
            if (item.dueDatetime) {
                const todayStr = getTodayDateString();
                const itemDate = item.dueDatetime.includes('T') ? item.dueDatetime.split('T')[0] : item.dueDatetime;
                const isToday = itemDate === todayStr;
                
                console.log('Rendering item', item.title, '- dueDatetime:', item.dueDatetime, 'itemDate:', itemDate, 'todayStr:', todayStr, 'isToday:', isToday);
                
                titleHtml += '<span style="color: #6c757d; font-size: 11px; margin-right: 6px;">';
                if (isToday) {
                    titleHtml += '<span style="color: #ff8c00;">Today</span>';
                } else {
                    titleHtml += formatDate(item.dueDatetime);
                }
                if (item.startTime) titleHtml += ' ' + item.startTime;
                if (item.deadline) titleHtml += ' (D)';
                titleHtml += '</span>';
            }
            titleHtml += item.title;
            
            html += '<div class="item-title">' + titleHtml + '</div>';
            
            if (showCheckbox) {
                html += '</div></div>';
            }
            
            html += '</div>';
            return html;
        }
        
        function render() {
            // Inbox
            document.getElementById('inbox-content').innerHTML = 
                getInboxItems().map(i => renderItem(i)).join('');
            
            // Calendar
            const calItems = getCalendarItems();
            document.getElementById('calendar-content').innerHTML = 
                calItems.length ? calItems.map(i => renderItem(i, true)).join('') : '<div class="empty-state">No scheduled items</div>';
            
            // Next Actions
            const nextActions = getNextActions();
            document.getElementById('next-content').innerHTML = 
                nextActions.length ? nextActions.map(i => renderItem(i, true)).join('') : '<div class="empty-state">No next actions</div>';
            
            // Someday
            document.getElementById('someday-content').innerHTML = 
                getSomedayItems().map(i => renderItem(i)).join('');
            
            // Projects
            let projectsListHtml = '';
            const sortedProjects = data.projects.sort((a, b) => (a.position || 0) - (b.position || 0));
            
            if (sortedProjects.length === 0) {
                projectsListHtml = '<div class="empty-state">No projects. Click "+ New Project" to create one.</div>';
            } else {
                sortedProjects.forEach(project => {
                    const itemCount = data.items.filter(i => i.projectId === project.id && i.status === 'projects' && !i.done).length;
                    const isActive = selectedProjectId === project.id;
                    const chevron = isActive ? '‚ñº' : '‚ñ∂'; // ‚ñº or ‚ñ∂
                    projectsListHtml += '<div class="project-list-item' + (isActive ? ' active' : '') + '" data-project-id="' + project.id + '">';
                    projectsListHtml += '<span class="project-chevron">' + chevron + '</span>';
                    projectsListHtml += '<span class="project-list-item-name">' + project.name + '</span>';
                    projectsListHtml += '<span style="font-size: 11px; color: #6c757d;">' + itemCount + '</span>';
                    projectsListHtml += '</div>';
                });
            }
            
            document.getElementById('projects-list').innerHTML = projectsListHtml;
            
            // Attach project interaction listeners
            document.querySelectorAll('.project-list-item').forEach(el => {
                const projectId = parseInt(el.dataset.projectId);
                let mouseDownTime = 0;
                let isDragAllowed = false;
                
                // Left click to select
                el.addEventListener('click', function(e) {
                    if (!isDragAllowed) {
                        selectProject(projectId);
                    }
                    isDragAllowed = false;
                });
                
                // Right click to edit
                el.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    editProject(projectId);
                });
                
                // Mouse down - enable dragging and start timer
                el.addEventListener('mousedown', function(e) {
                    if (e.button !== 0) return; // Only left mouse button
                    mouseDownTime = Date.now();
                    isDragAllowed = false;
                    el.setAttribute('draggable', 'true');
                });
                
                // Mouse up - disable dragging
                el.addEventListener('mouseup', function(e) {
                    mouseDownTime = 0;
                    el.removeAttribute('draggable');
                    el.style.cursor = 'pointer';
                });
                
                // Drag handlers
                el.addEventListener('dragstart', function(e) {
                    const holdTime = Date.now() - mouseDownTime;
                    if (holdTime < 150) {
                        // Not held long enough, cancel drag
                        e.preventDefault();
                        el.removeAttribute('draggable');
                        return;
                    }
                    // Held long enough, allow drag
                    isDragAllowed = true;
                    el.style.cursor = 'move';
                    handleProjectDragStart(e);
                });
                
                el.addEventListener('dragend', function(e) {
                    handleProjectDragEnd(e);
                    isDragAllowed = false;
                    mouseDownTime = 0;
                    el.removeAttribute('draggable');
                    el.style.cursor = 'pointer';
                });
                
                el.addEventListener('dragover', handleProjectDragOver);
                el.addEventListener('dragenter', handleProjectDragEnter);
                el.addEventListener('dragleave', handleProjectDragLeave);
                el.addEventListener('drop', handleProjectDrop);
            });
            
            // Update project selector in edit modal
            const projectSelect = document.getElementById('editProject');
            projectSelect.innerHTML = '<option value="">None</option>' + 
                data.projects.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('');
            
            // Attach drag listeners
            document.querySelectorAll('.item').forEach(el => {
                el.addEventListener('dragstart', handleDragStart);
                el.addEventListener('dragend', handleDragEnd);
                el.addEventListener('dragover', handleDragOver);
                el.addEventListener('dragenter', handleDragEnter);
                el.addEventListener('dragleave', handleDragLeave);
                el.addEventListener('drop', handleDrop);
                el.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('checkbox')) {
                        e.preventDefault();
                        showContextMenu(e, parseInt(el.dataset.id));
                    }
                });
                el.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    openItemModal(parseInt(el.dataset.id));
                });
            });
            
            // Attach drop listeners
            document.querySelectorAll('[data-status]').forEach(el => {
                el.addEventListener('dragover', handleDragOver);
                el.addEventListener('dragenter', handleDragEnter);
                el.addEventListener('dragleave', handleDragLeave);
                el.addEventListener('drop', handleDrop);
            });
            
            document.querySelectorAll('[data-project-id]').forEach(el => {
                el.addEventListener('dragover', handleDragOver);
                el.addEventListener('dragenter', handleDragEnter);
                el.addEventListener('dragleave', handleDragLeave);
                el.addEventListener('drop', handleDrop);
            });
            
            // Update stats
            updateStats();
        }
        
        let selectedProjectId = null;
        
        function selectProject(projectId) {
            selectedProjectId = projectId;
            
            // Update active state in sidebar
            document.querySelectorAll('.project-list-item').forEach(el => {
                el.classList.toggle('active', parseInt(el.dataset.projectId) === projectId);
            });
            
            // Render project items in detail panel
            const project = data.projects.find(p => p.id === projectId);
            const projectItems = data.items
                .filter(i => i.projectId === projectId && i.status === 'projects')
                .sort((a, b) => (a.position || 0) - (b.position || 0));
            
            let detailHtml = '';
            if (projectItems.length === 0) {
                detailHtml = '<div class="empty-state">No items in this project</div>';
            } else {
                detailHtml = projectItems.map(i => renderItem(i)).join('');
            }
            
            document.getElementById('projects-detail').innerHTML = detailHtml;
            document.getElementById('projects-detail').dataset.projectId = projectId;
            
            // Attach drag listeners to items
            document.querySelectorAll('#projects-detail .item').forEach(el => {
                el.addEventListener('dragstart', handleDragStart);
                el.addEventListener('dragend', handleDragEnd);
                el.addEventListener('dragover', handleDragOver);
                el.addEventListener('dragenter', handleDragEnter);
                el.addEventListener('dragleave', handleDragLeave);
                el.addEventListener('drop', handleDrop);
                el.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('checkbox')) {
                        e.preventDefault();
                        showContextMenu(e, parseInt(el.dataset.id));
                    }
                });
                el.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    openItemModal(parseInt(el.dataset.id));
                });
            });
            
            // Make detail panel droppable
            const detailPanel = document.getElementById('projects-detail');
            detailPanel.addEventListener('dragover', handleDragOver);
            detailPanel.addEventListener('dragenter', handleDragEnter);
            detailPanel.addEventListener('dragleave', handleDragLeave);
            detailPanel.addEventListener('drop', handleDrop);
        }
        
        function updateStats() {
            const totalItems = data.items.length;
            const doneItems = data.items.filter(i => i.done).length;
            const totalProjects = data.projects.length;
            const scheduledItems = data.items.filter(i => i.dueDatetime).length;
            
            document.getElementById('statsItems').textContent = totalItems;
            document.getElementById('statsDone').textContent = doneItems;
            document.getElementById('statsProjects').textContent = totalProjects;
            document.getElementById('statsScheduled').textContent = scheduledItems;
        }
        
        // Project drag and drop handlers
        function handleProjectDragStart(e) {
            const projectItem = e.target.closest('.project-list-item');
            if (!projectItem) return;
            
            draggedProject = parseInt(projectItem.dataset.projectId);
            projectItem.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        
        function handleProjectDragEnd(e) {
            const projectItem = e.target.closest('.project-list-item');
            if (projectItem) {
                projectItem.classList.remove('dragging');
            }
            document.querySelectorAll('.project-pane-insert-indicator, .project-list-insert-indicator').forEach(el => el.remove());
            draggedProject = null;
        }
        
        function handleProjectDragEnter(e) {
            if (!draggedProject) return;
            e.preventDefault();
        }
        
        function handleProjectDragLeave(e) {
            if (!draggedProject) return;
        }
        
        function handleProjectDragOver(e) {
            e.preventDefault();
            if (!draggedProject) return;
            
            const targetItem = e.currentTarget;
            const targetProjectId = parseInt(targetItem.dataset.projectId);
            
            if (targetProjectId === draggedProject) return;
            
            // Remove all existing indicators
            document.querySelectorAll('.project-pane-insert-indicator, .project-list-insert-indicator').forEach(el => el.remove());
            
            // Determine if we're on the top or bottom half of the target item
            const rect = targetItem.getBoundingClientRect();
            const mouseY = e.clientY;
            const midpoint = rect.top + rect.height / 2;
            const insertBefore = mouseY < midpoint;
            
            // Store drop information
            targetItem._closestProjectId = targetProjectId;
            targetItem._insertBefore = insertBefore;
            
            // Show indicator on the current target item
            const indicator = document.createElement('div');
            indicator.className = 'project-list-insert-indicator ' + (insertBefore ? 'before' : 'after');
            targetItem.appendChild(indicator);
        }
        
        async function handleProjectDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            document.querySelectorAll('.project-pane-insert-indicator, .project-list-insert-indicator').forEach(el => el.remove());
            
            if (!draggedProject) return;
            
            const target = e.currentTarget;
            if (!target._closestProjectId) return;
            
            const projects = data.projects.sort((a, b) => (a.position || 0) - (b.position || 0));
            const oldIndex = projects.findIndex(p => p.id === draggedProject);
            let targetIndex = projects.findIndex(p => p.id === target._closestProjectId);
            
            if (oldIndex === -1 || targetIndex === -1) return;
            
            if (!target._insertBefore) {
                targetIndex++;
            }
            
            if (oldIndex < targetIndex) {
                targetIndex--;
            }
            
            if (oldIndex === targetIndex) return;
            
            // Reorder projects
            const reordered = projects.filter(p => p.id !== draggedProject);
            const draggedProjectObj = projects[oldIndex];
            reordered.splice(targetIndex, 0, draggedProjectObj);
            
            // Update local data immediately (optimistic update)
            reordered.forEach((project, index) => {
                const dataProject = data.projects.find(p => p.id === project.id);
                if (dataProject) {
                    dataProject.position = index;
                }
            });
            
            // Refresh the project list immediately
            render();
            
            // Send update to server in background
            const updates = reordered.map((project, index) => ({
                id: project.id,
                position: index
            }));
            
            fetch('/api/projects/batch', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updates)
            }).catch(err => {
                console.error('Failed to save project positions:', err);
                // On error, reload from server
                loadData();
            });
        }
        
        // Item drag and drop handlers
        function handleDragStart(e) {
            draggedItem = parseInt(e.target.dataset.id);
            e.target.classList.add('dragging');
        }
        
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            // Clean up all visual feedback
            document.querySelectorAll('.drop-target-hover, .drop-target-project, .drop-zone-active').forEach(el => {
                el.classList.remove('drop-target-hover', 'drop-target-project', 'drop-zone-active');
                el._dragDepth = 0; // Reset drag depth counters
            });
            document.querySelectorAll('.insert-indicator').forEach(el => el.remove());
            draggedItem = null;
        }
        
        function handleDragEnter(e) {
            if (!draggedItem) return;
            e.preventDefault();
            
            const target = e.currentTarget;
            
            // Track drag depth to prevent flickering from child elements
            if (!target._dragDepth) target._dragDepth = 0;
            target._dragDepth++;
            
            // Only apply visual feedback on first enter
            if (target._dragDepth !== 1) return;
            
            // Highlight panes
            if (target.dataset.status || target.dataset.projectId) {
                if (target.classList.contains('pane-content')) {
                    target.classList.add('drop-zone-active');
                } else if (target.classList.contains('project-pane')) {
                    target.classList.add('drop-zone-active');
                }
            }
        }
        
        function handleDragLeave(e) {
            if (!draggedItem) return;
            const target = e.currentTarget;
            
            // Track drag depth to prevent flickering from child elements
            if (!target._dragDepth) target._dragDepth = 0;
            target._dragDepth--;
            
            // Only remove visual feedback when fully leaving the element
            if (target._dragDepth > 0) return;
            
            // Remove highlights
            target.classList.remove('drop-target-hover', 'drop-target-project', 'drop-zone-active');
            
            // Remove insertion indicators from this element
            const indicators = target.querySelectorAll('.insert-indicator');
            indicators.forEach(ind => ind.remove());
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            
            if (!draggedItem) return;
            const item = data.items.find(i => i.id === draggedItem);
            if (!item) return;
            
            // Remove all existing indicators
            document.querySelectorAll('.insert-indicator').forEach(el => el.remove());
            
            // Check if we're in the project detail pane and dragging a project item
            const projectDetail = e.target.closest('#projects-detail');
            if (!projectDetail || item.status !== 'projects') return;
            
            const projectId = parseInt(projectDetail.dataset.projectId);
            if (!projectId || item.projectId !== projectId) return;
            
            // Get all items in this project
            const projectItems = Array.from(projectDetail.querySelectorAll('.item'))
                .map(el => {
                    const rect = el.getBoundingClientRect();
                    return {
                        id: parseInt(el.dataset.id),
                        element: el,
                        midpoint: rect.top + rect.height / 2,
                        top: rect.top,
                        bottom: rect.bottom
                    };
                })
                .filter(itemData => itemData.id !== draggedItem); // Exclude dragged item
            
            if (projectItems.length === 0) return;
            
            const mouseY = e.clientY;
            
            // Find closest item based on distance to midpoint
            let closest = projectItems[0];
            let minDistance = Math.abs(mouseY - closest.midpoint);
            
            for (let i = 1; i < projectItems.length; i++) {
                const distance = Math.abs(mouseY - projectItems[i].midpoint);
                if (distance < minDistance) {
                    minDistance = distance;
                    closest = projectItems[i];
                }
            }
            
            // Determine if mouse is above or below the closest item's midpoint
            const insertBefore = mouseY < closest.midpoint;
            
            // Store drop information on the project detail pane
            projectDetail._closestItemId = closest.id;
            projectDetail._insertBefore = insertBefore;
            
            // Show indicator
            const indicator = document.createElement('div');
            indicator.className = 'insert-indicator';
            indicator.style.top = insertBefore ? '-4px' : 'calc(100% + 4px)';
            closest.element.appendChild(indicator);
        }
        
        async function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();  // Prevent bubbling to project pane
            
            // Clean up visual feedback
            document.querySelectorAll('.drop-target-hover, .drop-target-project, .drop-zone-active').forEach(el => {
                el.classList.remove('drop-target-hover', 'drop-target-project', 'drop-zone-active');
            });
            document.querySelectorAll('.insert-indicator').forEach(el => el.remove());
            
            if (!draggedItem) return;
            
            const item = data.items.find(i => i.id === draggedItem);
            if (!item) return;
            
            const target = e.currentTarget;
            
            // Check if dropped in the project detail pane for reordering
            const projectDetail = target.closest('#projects-detail');
            if (projectDetail && projectDetail._closestItemId && item.status === 'projects') {
                const projectId = parseInt(projectDetail.dataset.projectId);
                
                if (item.projectId === projectId) {
                    // Reordering within same project
                    const projectItems = data.items
                        .filter(i => i.projectId === projectId && i.status === 'projects')
                        .sort((a, b) => (a.position || 0) - (b.position || 0));
                    
                    const oldIndex = projectItems.findIndex(i => i.id === draggedItem);
                    let targetIndex = projectItems.findIndex(i => i.id === projectDetail._closestItemId);
                    
                    if (oldIndex !== -1 && targetIndex !== -1) {
                        // If inserting after, increment target index
                        if (!projectDetail._insertBefore) {
                            targetIndex++;
                        }
                        
                        // Adjust if moving down (removal shifts indices)
                        if (oldIndex < targetIndex) {
                            targetIndex--;
                        }
                        
                        // Only update if position actually changes
                        if (oldIndex !== targetIndex) {
                            const reordered = projectItems.filter(i => i.id !== draggedItem);
                            const draggedItemObj = projectItems[oldIndex];
                            reordered.splice(targetIndex, 0, draggedItemObj);
                            
                            // Update local data immediately (optimistic update)
                            reordered.forEach((item, index) => {
                                const dataItem = data.items.find(i => i.id === item.id);
                                if (dataItem) {
                                    dataItem.position = index;
                                }
                            });
                            
                            // Refresh the project view immediately
                            selectProject(selectedProjectId);
                            
                            // Send update to server in background
                            const updates = reordered.map((item, index) => ({
                                id: item.id,
                                position: index
                            }));
                            
                            fetch('/api/items/batch', {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(updates)
                            }).catch(err => {
                                console.error('Failed to save item positions:', err);
                                // On error, reload from server
                                loadData();
                            });
                        }
                        return;
                    }
                }
            }
            
            // Check if dropped on an item to add to that item's project
            if (target.classList.contains('item')) {
                const targetItemId = parseInt(target.dataset.id);
                const targetItem = data.items.find(i => i.id === targetItemId);
                
                if (targetItem && targetItem.projectId) {
                    const projectId = targetItem.projectId;
                    const projectItems = data.items.filter(i => i.projectId === projectId && i.status === 'projects');
                    const maxPos = projectItems.length > 0 ? Math.max(...projectItems.map(i => i.position || 0)) : -1;
                    
                    await fetch('/api/items/' + draggedItem, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'projects', projectId, position: maxPos + 1 })
                    });
                    await loadData();
                    return;
                }
            }
            
            const newStatus = target.dataset.status;
            const newProjectId = target.dataset.projectId;
            
            if (newStatus) {
                // Dropped into inbox or someday
                await fetch('/api/items/' + draggedItem, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus, projectId: null, position: 0 })
                });
            } else if (newProjectId) {
                // Dropped into a project (via project detail pane)
                const projectId = parseInt(newProjectId);
                const projectItems = data.items.filter(i => i.projectId === projectId && i.status === 'projects');
                const maxPos = projectItems.length > 0 ? Math.max(...projectItems.map(i => i.position || 0)) : -1;
                
                await fetch('/api/items/' + draggedItem, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'projects', projectId, position: maxPos + 1 })
                });
            }
            
            await loadData();
        }
        
        async function quickCapture() {
            const title = document.getElementById('quickTitle').value.trim();
            if (!title) return;
            
            const date = document.getElementById('quickDate').value;
            const time = document.getElementById('quickTime').value;
            const deadline = document.getElementById('quickDeadline').checked;
            
            await fetch('/api/items', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title,
                    status: 'inbox',
                    dueDatetime: date || null,
                    startTime: time || null,
                    deadline: deadline,
                    position: 0
                })
            });
            
            document.getElementById('quickTitle').value = '';
            document.getElementById('quickDate').value = '';
            document.getElementById('quickTime').value = '';
            document.getElementById('quickDeadline').checked = false;
            
            await loadData();
        }
        
        async function toggleDone(itemId, e) {
            e.stopPropagation();
            const item = data.items.find(i => i.id === itemId);
            if (!item) return;
            
            await fetch('/api/items/' + itemId, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ done: !item.done })
            });
            
            await loadData();
        }
        
        function openItemModal(itemId) {
            currentItem = data.items.find(i => i.id === itemId);
            if (!currentItem) return;
            
            document.getElementById('editTitle').value = currentItem.title;
            document.getElementById('editNotes').value = currentItem.notes || '';
            document.getElementById('editDate').value = currentItem.dueDatetime ? currentItem.dueDatetime.split('T')[0] : '';
            document.getElementById('editTime').value = currentItem.startTime || '';
            document.getElementById('editDeadline').checked = currentItem.deadline || false;
            document.getElementById('editProject').value = currentItem.projectId || '';
            
            document.getElementById('itemModal').classList.add('show');
        }
        
        function closeItemModal() {
            document.getElementById('itemModal').classList.remove('show');
            currentItem = null;
        }
        
        async function saveItem() {
            if (!currentItem) return;
            
            const title = document.getElementById('editTitle').value.trim();
            if (!title) return;
            
            const updates = {
                title,
                notes: document.getElementById('editNotes').value || null,
                dueDatetime: document.getElementById('editDate').value || null,
                startTime: document.getElementById('editTime').value || null,
                deadline: document.getElementById('editDeadline').checked,
                projectId: parseInt(document.getElementById('editProject').value) || null
            };
            
            if (updates.projectId) {
                updates.status = 'projects';
            } else if (currentItem.status === 'projects') {
                updates.status = 'inbox';
            }
            
            await fetch('/api/items/' + currentItem.id, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updates)
            });
            
            closeItemModal();
            await loadData();
        }
        
        async function deleteItem() {
            if (!currentItem || !confirm('Delete this item?')) return;
            
            await fetch('/api/items/' + currentItem.id, {
                method: 'DELETE'
            });
            
            closeItemModal();
            await loadData();
        }
        
        // Context Menu Functions
        let contextMenuItem = null;
        
        function showContextMenu(event, itemId) {
            event.preventDefault();
            event.stopPropagation();
            
            contextMenuItem = data.items.find(i => i.id === itemId);
            if (!contextMenuItem) return;
            
            const contextMenu = document.getElementById('contextMenu');
            const menuItems = contextMenu.querySelectorAll('.context-menu-item');
            
            // Show/hide menu items based on current item status
            menuItems.forEach(item => {
                const action = item.getAttribute('data-action');
                
                // Hide current area from the menu
                if (action === 'move-inbox' && contextMenuItem.status === 'inbox') {
                    item.style.display = 'none';
                } else if (action === 'move-someday' && contextMenuItem.status === 'someday') {
                    item.style.display = 'none';
                } else if (action === 'move-project' && contextMenuItem.status === 'projects') {
                    item.style.display = 'none';
                } else {
                    item.style.display = 'block';
                }
            });
            
            // Position the menu at click location
            contextMenu.style.left = event.pageX + 'px';
            contextMenu.style.top = event.pageY + 'px';
            contextMenu.classList.add('show');
        }
        
        function hideContextMenu() {
            document.getElementById('contextMenu').classList.remove('show');
            contextMenuItem = null;
        }
        
        async function handleContextMenuAction(action) {
            if (!contextMenuItem) return;
            
            console.log('Context menu action:', action, 'Item:', contextMenuItem);
            
            const itemId = contextMenuItem.id; // Save the ID before hiding the menu
            
            if (action === 'move-inbox') {
                await moveItemTo(itemId, 'inbox');
                hideContextMenu();
            } else if (action === 'move-someday') {
                await moveItemTo(itemId, 'someday');
                hideContextMenu();
            } else if (action === 'move-project') {
                console.log('About to show project select modal');
                hideContextMenu();
                showProjectSelectModal(itemId);
            }
        }
        
        async function moveItemTo(itemId, targetStatus, projectId = null) {
            const updates = {
                status: targetStatus,
                projectId: projectId
            };
            
            await fetch('/api/items/' + itemId, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updates)
            });
            
            await loadData();
        }
        
        function showProjectSelectModal(itemId) {
            console.log('showProjectSelectModal called with itemId:', itemId);
            const item = data.items.find(i => i.id === itemId);
            if (!item) {
                console.log('Item not found!');
                return;
            }
            
            console.log('Projects:', data.projects);
            const projectList = document.getElementById('projectSelectList');
            projectList.innerHTML = data.projects.map(project => 
                '<div class="project-select-item" onclick="selectProjectAndMove(' + itemId + ', ' + project.id + ')">' +
                project.name +
                '</div>'
            ).join('');
            
            if (data.projects.length === 0) {
                projectList.innerHTML = '<div style="color: #adb5bd; text-align: center; padding: 20px;">No projects available. Create a project first.</div>';
            }
            
            console.log('Adding show class to modal');
            document.getElementById('projectSelectModal').classList.add('show');
        }
        
        function closeProjectSelectModal() {
            document.getElementById('projectSelectModal').classList.remove('show');
        }
        
        async function selectProjectAndMove(itemId, projectId) {
            await moveItemTo(itemId, 'projects', projectId);
            closeProjectSelectModal();
        }
        
        function newProject() {
            currentProject = null;
            document.getElementById('projectModalTitle').textContent = 'New Project';
            document.getElementById('projectName').value = '';
            document.getElementById('projectOutcome').value = '';
            document.getElementById('deleteProjectBtn').style.display = 'none';
            document.getElementById('projectModal').classList.add('show');
        }
        
        function editProject(projectId) {
            currentProject = data.projects.find(p => p.id === projectId);
            if (!currentProject) return;
            
            document.getElementById('projectModalTitle').textContent = 'Edit Project';
            document.getElementById('projectName').value = currentProject.name;
            document.getElementById('projectOutcome').value = currentProject.outcome || '';
            document.getElementById('deleteProjectBtn').style.display = 'inline-block';
            document.getElementById('projectModal').classList.add('show');
        }
        
        function closeProjectModal() {
            document.getElementById('projectModal').classList.remove('show');
            currentProject = null;
        }
        
        async function saveProject() {
            const name = document.getElementById('projectName').value.trim();
            if (!name) return;
            
            const projectData = {
                name,
                outcome: document.getElementById('projectOutcome').value || null,
                status: 'active'
            };
            
            if (currentProject) {
                await fetch('/api/projects/' + currentProject.id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(projectData)
                });
            } else {
                await fetch('/api/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(projectData)
                });
            }
            
            closeProjectModal();
            await loadData();
        }
        
        async function deleteProject() {
            if (!currentProject || !confirm('Delete this project? Items will be moved to inbox.')) return;
            
            await fetch('/api/projects/' + currentProject.id, {
                method: 'DELETE'
            });
            
            closeProjectModal();
            await loadData();
        }
        
        // Keyboard shortcut for quick capture
        document.addEventListener('keydown', function(e) {
            if ((e.key === 'q' || e.key === 'c') && !e.ctrlKey && !e.metaKey && 
                document.activeElement.tagName !== 'INPUT' && 
                document.activeElement.tagName !== 'TEXTAREA') {
                document.getElementById('quickTitle').focus();
            }
        });
        
        // Enter key in quick capture
        document.getElementById('quickTitle').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') quickCapture();
        });
        
        // Context menu event listeners
        document.querySelectorAll('.context-menu-item').forEach(item => {
            item.addEventListener('click', function() {
                const action = this.getAttribute('data-action');
                handleContextMenuAction(action);
            });
        });
        
        // Hide context menu when clicking elsewhere
        document.addEventListener('click', function(e) {
            const contextMenu = document.getElementById('contextMenu');
            if (!contextMenu.contains(e.target) && contextMenu.classList.contains('show')) {
                hideContextMenu();
            }
        });
        
        // Initialize
        checkSession();
    </script>
</body>
</html>